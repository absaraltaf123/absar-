<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enhanced Graph Creator with Trig Functions & More Charts</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Chart.js and plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- Brython -->
    <script src="https://cdn.jsdelivr.net/npm/brython@3.10.5/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.10.5/brython_stdlib.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        background: linear-gradient(135deg, #2b1055, #7597de);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
        color: #fff;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }
      
      /* Add animated background elements */
      body::before {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><circle cx="30" cy="30" r="20" fill="rgba(255,255,255,0.03)"/><circle cx="70" cy="70" r="30" fill="rgba(255,255,255,0.02)"/></svg>');
        background-size: 100px 100px;
        opacity: 0.5;
        animation: backgroundMove 60s linear infinite;
      }
      
      @keyframes backgroundMove {
        0% { background-position: 0 0; }
        100% { background-position: 100px 100px; }
      }
      
      .container {
        display: flex;
        width: 95%;
        height: 95%;
        max-width: 1400px;
        border-radius: 24px;
        overflow: hidden;
        padding: 8px;
        background: linear-gradient(135deg, #6a3093, #a044ff);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4),
                   inset 0 2px 10px rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        position: relative;
        z-index: 10;
        animation: containerGlow 5s ease-in-out infinite alternate;
      }
      
      @keyframes containerGlow {
        0% { box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4), inset 0 2px 10px rgba(255, 255, 255, 0.2); }
        100% { box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4), 0 0 20px rgba(160, 68, 255, 0.6), inset 0 2px 10px rgba(255, 255, 255, 0.2); }
      }
      
      .content-wrapper {
        display: flex;
        width: 100%;
        height: 100%;
        background: linear-gradient(to right, rgba(20, 20, 31, 0.95), rgba(30, 30, 45, 0.95));
        border-radius: 18px;
        overflow: hidden;
        box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.07);
        position: relative;
      }
      
      /* Add subtle grid pattern to content-wrapper */
      .content-wrapper::before {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        background-image: 
          linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
          linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 20px 20px;
        z-index: -1;
      }
      .graph-panel {
        flex: 2.3;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        background: linear-gradient(145deg, #131313, #1d1d1d);
        border-radius: 12px;
        box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.5);
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }
      
      /* Add subtle animated glow to graph panel */
      .graph-panel::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(160, 68, 255, 0.5), transparent);
        animation: glowScan 4s ease-in-out infinite;
      }
      
      @keyframes glowScan {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }
      
      .graph-header {
        padding: 17px 25px;
        font-weight: bold;
        font-size: 1.1rem;
        letter-spacing: 1px;
        backdrop-filter: blur(10px);
        background: linear-gradient(90deg, rgba(106, 48, 147, 0.2), rgba(160, 68, 255, 0.2));
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        display: flex;
        align-items: center;
        text-transform: uppercase;
        color: #fff;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      
      /* Add icon to graph header */
      .graph-header::before {
        content: "📊";
        margin-right: 10px;
        font-size: 1.2rem;
      }
      
      .graph-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: rgba(24, 24, 24, 0.7);
        border-radius: 0 0 12px 12px;
        position: relative;
        transition: all 0.3s ease;
      }
      
      .graph-content:hover {
        box-shadow: inset 0 0 20px rgba(160, 68, 255, 0.1);
      }
      
      /* Add subtle grid to graph content */
      .graph-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
          radial-gradient(circle, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 20px 20px;
        opacity: 0.5;
        pointer-events: none;
        z-index: 0;
      }

      /* Enhanced Canvas Styling */
      canvas#myChart {
        max-width: 100%;
        max-height: 100%;
        border-radius: 16px;
        background: linear-gradient(120deg, rgba(22, 22, 30, 0.95), rgba(38, 38, 55, 0.95));
        box-shadow: 
          0 10px 30px rgba(0, 0, 0, 0.2),
          0 0 15px rgba(160, 68, 255, 0.2);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        animation: chart-glow 6s ease-in-out infinite alternate;
      }

      canvas#myChart:hover {
        box-shadow: 
          0 15px 40px rgba(0, 0, 0, 0.3),
          0 0 20px rgba(160, 68, 255, 0.4);
        transform: translateY(-5px) scale(1.01);
      }

      @keyframes chart-glow {
        0% {
          box-shadow: 
            0 10px 30px rgba(0, 0, 0, 0.2),
            0 0 15px rgba(160, 68, 255, 0.2);
        }
        100% {
          box-shadow:
            0 10px 30px rgba(0, 0, 0, 0.3),
            0 0 25px rgba(160, 68, 255, 0.5);
        }
      }

      /* Chart Overlay Effects */
      .chart-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
        border-radius: 16px;
        background: 
          radial-gradient(circle at top right, rgba(160, 68, 255, 0.08), transparent 50%),
          radial-gradient(circle at bottom left, rgba(106, 48, 147, 0.08), transparent 50%);
      }
      
      /* Background grid animation for the chart */
      .graph-content::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
          linear-gradient(90deg, rgba(50, 50, 70, 0.03) 1px, transparent 1px),
          linear-gradient(rgba(50, 50, 70, 0.03) 1px, transparent 1px);
        background-size: 20px 20px;
        z-index: -1;
        animation: gridMove 60s linear infinite;
        opacity: 0.5;
      }
      
      @keyframes gridMove {
        0% { background-position: 0 0; }
        100% { background-position: 20px 20px; }
      }
      
      /* Enhanced data point highlight */
      .highlight-point {
        position: absolute;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: rgba(160, 68, 255, 0.8);
        transform: translate(-50%, -50%);
        box-shadow: 0 0 15px rgba(160, 68, 255, 0.6);
        pointer-events: none;
        opacity: 0;
        z-index: 10;
        animation: pulse 2s ease-in-out infinite;
      }
      
      @keyframes pulse {
        0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.4; }
        50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.8; }
        100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.4; }
      }
      
      /* Graph reveal animation */
      .graph-reveal {
        animation: revealGraph 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      
      @keyframes revealGraph {
        0% { opacity: 0; transform: scale(0.9) translateY(20px); }
        100% { opacity: 1; transform: scale(1) translateY(0); }
      }
      
      .input-panel {
        flex: 1;
        background: #1e1e1e;
        padding: 18px;
        overflow-y: auto;
        font-family: "Fira Code", monospace;
        font-size: 14px;
        line-height: 1.5;
      }
      .input-header {
        margin-bottom: 2px;
        color: #9e86ff;
        font-weight: bold;
        font-size: 0.9rem;
        padding: 2px 0;
      }
      .panel {
        display: none;
        flex-direction: column;
      }
      .panel.active {
        display: flex;
      }
      .form-label {
        margin-bottom: 0.5rem;
        display: block;
        color: #fff;
      }
      .form-control {
        width: 100%;
        padding: 10px;
        border-radius: 4px;
        background-color: #2a2a2a;
        border: 1px solid #444;
        color: #fff;
        outline: none;
        margin-bottom: 1rem;
      }
      .btn {
        border: none;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 8px;
        color: #fff;
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        align-self: center;
        margin-top: 1rem;
      }
      .btn-primary {
        background: linear-gradient(90deg, #4caf50, #81c784);
      }
      .btn-primary:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(76, 175, 80, 0.6);
      }
      .btn-secondary {
        background: linear-gradient(90deg, #ff8a80, #ff5252);
      }
      .btn-secondary:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(255, 82, 82, 0.6);
      }
      canvas {
        max-width: 100%;
        max-height: 100%;
        border-radius: 11px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .accordion-button {
        background-color: #343a40;
        color: #fff;
      }
      .accordion-button:not(.collapsed) {
        background-color: #495057;
        color: #fff;
      }
      .accordion-body {
        background-color: #495057;
        color: #fff;
      }
      #moreOptionsContainer {
        margin-top: 20px;
      }
      @media (max-width: 768px) {
        .content-wrapper {
          flex-direction: column;
          overflow: hidden;
          position: relative;
          height: 100%;
        }
        .graph-panel {
          flex: none;
          height: 40vh; /* Fixed height for graph panel */
          position: sticky;
          top: 0;
          z-index: 10;
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .input-panel {
          flex: 1;
          height: 60vh; /* Remaining space for controls */
          overflow-y: auto; /* Enable scrolling */
          position: relative;
          padding-bottom: 20px; /* Add some padding at the bottom */
        }
        /* Fix for nested input panel */
        .input-panel .input-panel {
          height: auto;
          overflow: visible;
        }
        /* Ensure enough space for all form elements */
        #moreOptionsContainer {
          padding-bottom: 50px;
        }
        /* Add smooth scrolling to make touch interactions feel better */
        * {
          -webkit-overflow-scrolling: touch;
        }
      }
      .custom-nav {
        display: flex;
        justify-content: space-around;
        background: linear-gradient(135deg, #1a1a2e, #2a2a4a);
        padding: 12px 15px;
        border-radius: 15px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2),
                   inset 0 1px 2px rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .custom-nav button {
        background: rgba(26, 26, 46, 0.6);
        color: #ffffff;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 12px 25px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        font-family: "Fira Code", monospace;
        letter-spacing: 0.5px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(5px);
        text-transform: uppercase;
        font-size: 13px;
      }

      .custom-nav button.active {
        background: linear-gradient(135deg, #9e86ff, #4c2c8c);
        color: #ffffff;
        box-shadow: 0 4px 15px rgba(158, 134, 255, 0.3);
        transform: translateY(-1px);
      }

      .custom-nav button:hover {
        background: linear-gradient(135deg, #4c2c8c, #2c1f3a);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 44, 140, 0.4);
      }
            /* Add these styles to your existing CSS */
            .function-select-wrapper {
        background: linear-gradient(145deg, #1e1e1e, #2a2a2a);
        border-radius: 12px;
        padding: 15px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.05);
        margin-bottom: 20px;
      }

      .function-select-label {
        color: #9e86ff;
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 12px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
      }

      .function-select {
        background: rgba(26, 26, 46, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 12px;
        color: #fff;
        font-family: "Fira Code", monospace;
        font-size: 14px;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
      }

      .function-select:hover {
        border-color: rgba(158, 134, 255, 0.4);
        box-shadow: 0 0 15px rgba(158, 134, 255, 0.1);
      }

      .function-select:focus {
        border-color: #9e86ff;
        box-shadow: 0 0 0 2px rgba(158, 134, 255, 0.2);
        outline: none;
      }

      .function-select option {
        background: #1a1a2e;
        color: #fff;
        padding: 10px;
      }
      .app-title {
        text-align: center;
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 15px;
        background: linear-gradient(135deg, #9e86ff, #4c2c8c);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        letter-spacing: 1px;
        padding: 5px 0;
      }
      .chart-type-wrapper {
        background: linear-gradient(145deg, #1e1e1e, #2a2a2a);
        border-radius: 12px;
        padding: 20px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.05);
        margin-bottom: 20px;
      }

      .chart-type-label {
        color: #9e86ff;
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 12px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .chart-type-label::before {
        content: "📊";
        font-size: 1.2rem;
      }

      .chart-type-select {
        background: rgba(26, 26, 46, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 12px;
        color: #fff;
        font-family: "Fira Code", monospace;
        font-size: 14px;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
        width: 100%;
        cursor: pointer;
      }

      .chart-type-select:hover {
        border-color: rgba(158, 134, 255, 0.4);
        box-shadow: 0 0 15px rgba(158, 134, 255, 0.1);
        transform: translateY(-1px);
      }

      .chart-type-select:focus {
        border-color: #9e86ff;
        box-shadow: 0 0 0 2px rgba(158, 134, 255, 0.2);
        outline: none;
      }

      .chart-type-select option {
        background: #1a1a2e;
        color: #fff;
        padding: 12px;
        font-size: 14px;
      }
      
      /* Implicit Function Program Overlay */
      .implicit-program-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #2b1055, #7597de);
        z-index: 1000;
        display: none;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        overflow: hidden;
      }
      
      .implicit-program-container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        padding: 20px;
      }
      
      .implicit-program-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      
      .implicit-program-title {
        font-size: 1.8rem;
        font-weight: 600;
        color: #fff;
        background: linear-gradient(135deg, #9e86ff, #4c2c8c);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }
      
      .implicit-back-btn {
        background: linear-gradient(90deg, #ff8a80, #ff5252);
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 82, 82, 0.3);
      }
      
      .implicit-back-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 82, 82, 0.5);
      }
      
      .implicit-program-content {
        position: relative;
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
      }
      
      .implicit-program-iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 12px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        z-index: 5;
      }
      
      /* Animation classes */
      .fade-in {
        display: block;
        animation: fadeIn 0.5s forwards;
      }
      
      .fade-out {
        animation: fadeOut 0.5s forwards;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; display: none; }
      }
      
      /* Loading spinner styles */
      .loading-spinner-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: rgba(43, 16, 85, 0.9);
        color: white;
        z-index: 10;
        border-radius: 12px;
        transition: opacity 0.5s ease;
      }
      
      .loading-spinner-container h3 {
        margin-bottom: 20px;
        font-size: 1.5rem;
        color: #fff;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        background: linear-gradient(135deg, #9e86ff, #4c2c8c);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      
      .loading-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 5px solid #9e86ff;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .loading-hidden {
        opacity: 0;
        pointer-events: none;
      }

      /* Add loading effect styles */
      .graph-loading {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(20, 20, 30, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-radius: 12px;
        z-index: 50;
        transition: opacity 0.3s ease;
      }

      .graph-loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        border-top: 4px solid #9e86ff;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
      }

      .graph-loading-text {
        color: #ffffff;
        font-family: "Fira Code", monospace;
        font-size: 16px;
        letter-spacing: 1px;
        background: linear-gradient(135deg, #9e86ff, #4c2c8c);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body onload="brython()">
    <div class="container">
      <div class="content-wrapper">
        <!-- Graph Display Panel -->
        <div class="graph-panel">
          <div class="graph-header">Graph Display</div>
          <div class="graph-content">
            <canvas id="myChart"></canvas>
          </div>
        </div>
        <div class="input-panel">
            <h1 class="app-title">ABS Graph Creator</h1>
          
        <!-- Input Panel -->
        <div class="input-panel">
          <div class="input-header">Graph Creator</div>
          <div class="custom-nav" id="modeTabs">
            <button class="active" id="data-tab" data-target="#dataPanel">Data</button>
            <button id="equation-tab" data-target="#equationPanel">Equation</button>
          </div>
          
          <!-- Data Entry Panel -->
          <div id="dataPanel" class="panel active">
            <h2>Enter Data</h2>
            <div class="mb-3">
              <label for="xValues" class="form-label">X-axis values:</label>
              <input type="text" id="xValues" class="form-control" placeholder="e.g. 1, 2, 3, 4 or A, B, C, D" />
            </div>
            <div class="mb-3">
              <label for="yValues" class="form-label">Y-axis values:</label>
              <input type="text" id="yValues" class="form-control" placeholder="e.g. 10, 20, 30, 40 or W, X, Y, Z" />
            </div>
            <button id="createBtn" class="btn btn-primary">Create Graph</button>
            <button id="clearDataBtn" class="btn btn-secondary">Clear Graph</button>
          </div>
          <!-- Equation Entry Panel -->
          <div id="equationPanel" class="panel">
            <h2>Enter Equation</h2>
            <div class="mb-3">
              <label for="equation" class="form-label">Equation (in terms of x):</label>
              <input type="text" id="equation" class="form-control" placeholder="e.g. x**2 + 2*x + 1" />
            </div>
            <div class="mb-3 function-select-wrapper">
                <label for="trigFunction" class="form-label function-select-label">Select a Function</label>
                <select id="trigFunction" class="form-control function-select">
                  <option value="">-- Select Function --</option>
                  <option value="math.sin(x)">sin(x)</option>
                  <option value="math.cos(x)">cos(x)</option>
                  <option value="math.tan(x)">tan(x)</option>
                  <option value="math.log(x)">log(x)</option>
                  <option value="math.exp(x)">exp(x)</option>
                  <option value="math.sqrt(x)">sqrt(x)</option>
                  <option value="abs(x)">abs(x)</option>
                  <option value="math.pow(x, 2)">x²</option>
                </select>
              </div>
            <div class="mb-3">
              <label for="startX" class="form-label">Start x:</label>
              <input type="text" id="startX" class="form-control" placeholder="e.g. -10" />
            </div>
            <div class="mb-3">
              <label for="endX" class="form-label">End x:</label>
              <input type="text" id="endX" class="form-control" placeholder="e.g. 10" />
            </div>
            <button id="createEquationBtn" class="btn btn-primary">Create Graph</button>
            <button id="clearEquationBtn" class="btn btn-secondary">Clear Graph</button>
            <div class="accordion mt-3" id="equationAdditionalAccordion">
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingAdditional">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdditional" aria-expanded="false" aria-controls="collapseAdditional">
                    Additional Equation Features
                  </button>
                </h2>
                <div id="collapseAdditional" class="accordion-collapse collapse" aria-labelledby="headingAdditional" data-bs-parent="#equationAdditionalAccordion">
                  <div class="accordion-body">
                    <h5>Interactive Parameter Sliders</h5>
                    <div class="mb-3">
                      <label for="paramA" class="form-label">Coefficient a:</label>
                      <input type="range" id="paramA" class="form-range" min="-10" max="10" step="0.1" value="1" />
                      <span id="paramAValue">1</span>
                    </div>
                    <div class="mb-3">
                      <label for="paramB" class="form-label">Coefficient b:</label>
                      <input type="range" id="paramB" class="form-range" min="-10" max="10" step="0.1" value="0" />
                      <span id="paramBValue">0</span>
                    </div>
                    <div class="mb-3">
                      <label for="paramC" class="form-label">Coefficient c:</label>
                      <input type="range" id="paramC" class="form-range" min="-10" max="10" step="0.1" value="0" />
                      <span id="paramCValue">0</span>
                    </div>
                    <button id="updateEquationWithParams" class="btn btn-primary">Update Equation</button>
                    <hr />
                    
                    <!-- DERIVATIVE VISUALIZATION SECTION -->
                    <h5>Derivative Visualization</h5>
                    <div class="mb-3">
                      <label class="form-label">Show Derivative:</label>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="showDerivative" />
                        <label class="form-check-label" for="showDerivative">Display derivative curve</label>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="derivativeColor" class="form-label">Derivative Color:</label>
                      <input type="color" id="derivativeColor" class="form-control" value="#ff5252" />
                    </div>
                    <div class="mb-3">
                      <label for="derivativeWidth" class="form-label">Derivative Line Width:</label>
                      <input type="range" id="derivativeWidth" class="form-range" min="1" max="5" step="0.5" value="2" />
                      <span id="derivativeWidthValue">2</span>
                    </div>
                    <div class="mb-3">
                      <button id="calculateDerivativeBtn" class="btn btn-primary">Show Derivative</button>
                    </div>
                    <hr />
                    
                    <!-- PROBABILITY DISTRIBUTIONS SECTION -->
                    <h5>Probability Distributions</h5>
                    <div class="mb-3">
                      <label for="distributionType" class="form-label">Distribution Type:</label>
                      <select id="distributionType" class="form-control">
                        <option value="normal">Normal (Gaussian) Distribution</option>
                        <option value="uniform">Uniform Distribution</option>
                        <option value="exponential">Exponential Distribution</option>
                        <option value="poisson">Poisson Distribution</option>
                        <option value="binomial">Binomial Distribution</option>
                      </select>
                    </div>
                    
                    <!-- Normal Distribution Parameters -->
                    <div id="normalParams" class="distribution-params">
                      <div class="mb-3">
                        <label for="normalMean" class="form-label">Mean (μ):</label>
                        <input type="range" id="normalMean" class="form-range" min="-5" max="5" step="0.1" value="0" />
                        <span id="normalMeanValue">0</span>
                      </div>
                      <div class="mb-3">
                        <label for="normalStdDev" class="form-label">Standard Deviation (σ):</label>
                        <input type="range" id="normalStdDev" class="form-range" min="0.1" max="3" step="0.1" value="1" />
                        <span id="normalStdDevValue">1</span>
                      </div>
                    </div>
                    
                    <!-- Uniform Distribution Parameters -->
                    <div id="uniformParams" class="distribution-params" style="display: none;">
                      <div class="mb-3">
                        <label for="uniformMin" class="form-label">Minimum (a):</label>
                        <input type="range" id="uniformMin" class="form-range" min="-5" max="0" step="0.1" value="-1" />
                        <span id="uniformMinValue">-1</span>
                      </div>
                      <div class="mb-3">
                        <label for="uniformMax" class="form-label">Maximum (b):</label>
                        <input type="range" id="uniformMax" class="form-range" min="0" max="5" step="0.1" value="1" />
                        <span id="uniformMaxValue">1</span>
                      </div>
                    </div>
                    
                    <!-- Exponential Distribution Parameters -->
                    <div id="exponentialParams" class="distribution-params" style="display: none;">
                      <div class="mb-3">
                        <label for="exponentialRate" class="form-label">Rate (λ):</label>
                        <input type="range" id="exponentialRate" class="form-range" min="0.1" max="2" step="0.1" value="1" />
                        <span id="exponentialRateValue">1</span>
                      </div>
                    </div>
                    
                    <!-- Poisson Distribution Parameters -->
                    <div id="poissonParams" class="distribution-params" style="display: none;">
                      <div class="mb-3">
                        <label for="poissonLambda" class="form-label">Lambda (λ):</label>
                        <input type="range" id="poissonLambda" class="form-range" min="0.1" max="10" step="0.1" value="3" />
                        <span id="poissonLambdaValue">3</span>
                      </div>
                    </div>
                    
                    <!-- Binomial Distribution Parameters -->
                    <div id="binomialParams" class="distribution-params" style="display: none;">
                      <div class="mb-3">
                        <label for="binomialN" class="form-label">Number of Trials (n):</label>
                        <input type="range" id="binomialN" class="form-range" min="1" max="30" step="1" value="10" />
                        <span id="binomialNValue">10</span>
                      </div>
                      <div class="mb-3">
                        <label for="binomialP" class="form-label">Success Probability (p):</label>
                        <input type="range" id="binomialP" class="form-range" min="0.01" max="0.99" step="0.01" value="0.5" />
                        <span id="binomialPValue">0.5</span>
                      </div>
                    </div>
                    
                    <div class="mb-3">
                      <button id="plotDistributionBtn" class="btn btn-primary">Plot Distribution</button>
                    </div>
                    <hr />
                    <h5>Implicit and Parametric Equations</h5>
                    <div class="mb-3">
                      <label class="form-label">Equation Type:</label>
                      <select id="equationType" class="form-control">
                        <option value="explicit" selected>Explicit (y = f(x))</option>
                        <option value="implicit">Implicit (F(x,y)=0)</option>
                        <option value="parametric">Parametric (x(t), y(t))</option>
                      </select>
                    </div>
                    <div id="parametricInputs" style="display: none;">
                      <div class="mb-3">
                        <label for="parametricX" class="form-label">x(t):</label>
                        <input type="text" id="parametricX" class="form-control" placeholder="e.g. cos(t)" />
                      </div>
                      <div class="mb-3">
                        <label for="parametricY" class="form-label">y(t):</label>
                        <input type="text" id="parametricY" class="form-control" placeholder="e.g. sin(t)" />
                      </div>
                      <div class="mb-3">
                        <label for="startT" class="form-label">Start t:</label>
                        <input type="text" id="startT" class="form-control" placeholder="e.g. 0" />
                      </div>
                      <div class="mb-3">
                        <label for="endT" class="form-label">End t:</label>
                        <input type="text" id="endT" class="form-control" placeholder="e.g. 6.28" />
                      </div>
                    </div>
                    <div id="implicitInput" style="display: none;">
                      <div class="mb-3">
                        <label for="implicitEquation" class="form-label">Implicit Equation (F(x,y)=0):</label>
                        <input type="text" id="implicitEquation" class="form-control" placeholder="e.g. x**2 + y**2 - 1" />
                      </div>
                      <div class="mb-3">
                        <label for="startXImplicit" class="form-label">Start x:</label>
                        <input type="text" id="startXImplicit" class="form-control" placeholder="e.g. -10" />
                      </div>
                      <div class="mb-3">
                        <label for="endXImplicit" class="form-label">End x:</label>
                        <input type="text" id="endXImplicit" class="form-control" placeholder="e.g. 10" />
                      </div>
                      <div class="mb-3">
                        <label for="startY" class="form-label">Start y:</label>
                        <input type="text" id="startY" class="form-control" placeholder="e.g. -1.5" />
                      </div>
                      <div class="mb-3">
                        <label for="endY" class="form-label">End y:</label>
                        <input type="text" id="endY" class="form-control" placeholder="e.g. 1.5" />
                      </div>
                    </div>
                    <hr />
                    <h5>Animation and Transformations</h5>
                    <div class="mb-3">
                      <label for="enableAnimation" class="form-label">Enable Animated Transitions:</label>
                      <input type="checkbox" id="enableAnimation" class="form-check-input" />
                    </div>
                    <div class="mb-3">
                      <label for="enableTransform" class="form-label">Show Transformations:</label>
                      <input type="checkbox" id="enableTransform" class="form-check-input" />
                    </div>
                    <button id="plotAdditionalBtn" class="btn btn-primary">Plot Equation</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- More Options Container (Data Mode) -->
          <div id="moreOptionsContainer">
            <div class="accordion" id="moreOptionsAccordion">
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingCustomization">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCustomization" aria-expanded="false" aria-controls="collapseCustomization">
                    Customization
                  </button>
                </h2>
                <div id="collapseCustomization" class="accordion-collapse collapse" aria-labelledby="headingCustomization" data-bs-parent="#moreOptionsAccordion">
                  <div class="accordion-body">
                    <div class="mb-3">
                      <label for="xAxisType" class="form-label">X Axis Data Type:</label>
                      <select id="xAxisType" class="form-control">
                        <option value="Numeric" selected>Numeric</option>
                        <option value="Alphabetic">Alphabetic</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="yAxisType" class="form-label">Y Axis Data Type:</label>
                      <select id="yAxisType" class="form-control">
                        <option value="Numeric" selected>Numeric</option>
                        <option value="Alphabetic">Alphabetic</option>
                      </select>
                    </div>
                    <div class="mb-3 chart-type-wrapper">
                      <label for="chartType" class="form-label chart-type-label">Chart Type</label>
                      <select id="chartType" class="form-control chart-type-select">
                          <option value="line" selected>📈 Line Chart</option>
                          <option value="bar">📊 Bar Chart</option>
                          <option value="scatter">🔵 Scatter Plot</option>
                          <option value="area">📉 Area Chart</option>
                          <option value="horizontalBar">📊 Horizontal Bar</option>
                          <option value="pie">🥧 Pie Chart</option>
                      </select>
                  </div>
                    <div class="mb-3">
                      <label for="chartTitle" class="form-label">Chart Title:</label>
                      <input type="text" id="chartTitle" class="form-control" placeholder="Enter Chart Title" />
                    </div>
                    <div class="mb-3">
                      <label for="xAxisLabel" class="form-label">X Axis Label:</label>
                      <input type="text" id="xAxisLabel" class="form-control" placeholder="Enter X Axis Label" />
                    </div>
                    <div class="mb-3">
                      <label for="yAxisLabel" class="form-label">Y Axis Label:</label>
                      <input type="text" id="yAxisLabel" class="form-control" placeholder="Enter Y Axis Label" />
                    </div>
                    <div class="mb-3">
                      <label for="datasetColor" class="form-label">Dataset Color:</label>
                      <input type="color" id="datasetColor" class="form-control" value="#4caf50" />
                    </div>
                    <div class="mb-3">
                      <label for="borderColor" class="form-label">Border Color:</label>
                      <input type="color" id="borderColor" class="form-control" value="#4caf50" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingFileOps">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFileOps" aria-expanded="false" aria-controls="collapseFileOps">
                    File Operations
                  </button>
                </h2>
                <div id="collapseFileOps" class="accordion-collapse collapse" aria-labelledby="headingFileOps" data-bs-parent="#moreOptionsAccordion">
                  <div class="accordion-body">
                    <div class="mb-3">
                      <label for="dataFileInput" class="form-label">Import Data File (CSV/JSON):</label>
                      <input type="file" id="dataFileInput" class="form-control" accept=".csv, .json" />
                    </div>
                    <div class="mb-3">
                      <button id="exportBtn" class="btn btn-primary">Export Graph</button>
                      <button id="resetZoomBtn" class="btn btn-secondary">Reset Zoom</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingAnalysis">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAnalysis" aria-expanded="false" aria-controls="collapseAnalysis">
                    Analysis Tools
                  </button>
                </h2>
                <div id="collapseAnalysis" class="accordion-collapse collapse" aria-labelledby="headingAnalysis" data-bs-parent="#moreOptionsAccordion">
                  <div class="accordion-body">
                    <div class="mb-3">
                      <button id="analyzeDataBtn" class="btn btn-primary">Analyze Data</button>
                      <button id="addRegressionBtn" class="btn btn-secondary">Add Regression Line</button>
                    </div>
                    <div id="analysisResults" class="mb-3" style="background: #2a2a2a; padding: 10px; border-radius: 5px;"></div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingAnnotations">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAnnotations" aria-expanded="false" aria-controls="collapseAnnotations">
                    Annotations
                  </button>
                </h2>
                <div id="collapseAnnotations" class="accordion-collapse collapse" aria-labelledby="headingAnnotations" data-bs-parent="#moreOptionsAccordion">
                  <div class="accordion-body">
                    <div class="mb-3">
                      <label for="annotationX" class="form-label">Annotation X:</label>
                      <input type="text" id="annotationX" class="form-control" placeholder="Enter X value for annotation" />
                    </div>
                    <div class="mb-3">
                      <label for="annotationLabel" class="form-label">Annotation Label:</label>
                      <input type="text" id="annotationLabel" class="form-control" placeholder="Enter annotation label" />
                    </div>
                    <div class="mb-3">
                      <button id="addAnnotationBtn" class="btn btn-primary">Add Annotation</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingDataTools">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDataTools" aria-expanded="false" aria-controls="collapseDataTools">
                    Data Tools
                  </button>
                </h2>
                <div id="collapseDataTools" class="accordion-collapse collapse" aria-labelledby="headingDataTools" data-bs-parent="#moreOptionsAccordion">
                  <div class="accordion-body">
                    <div class="mb-3">
                      <button id="viewDataTableBtn" class="btn btn-primary">View Data Table</button>
                    </div>
                    <div id="dataTableContainer" style="display: none; background: #2a2a2a; padding: 10px; border-radius: 5px; margin-bottom: 1rem;"></div>
                    <div class="mb-3">
                      <button id="downloadCSVBtn" class="btn btn-primary">Download Data as CSV</button>
                    </div>
                    <div class="mb-3">
                      <button id="saveConfigBtn" class="btn btn-primary">Save Chart Config</button>
                      <button id="loadConfigBtn" class="btn btn-secondary">Load Chart Config</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Implicit Function Program Overlay -->
    <div id="implicitProgramOverlay" class="implicit-program-overlay">
      <div class="implicit-program-container">
        <div class="implicit-program-header">
          <div class="implicit-program-title">Implicit Function Explorer</div>
          <button id="implicitBackBtn" class="implicit-back-btn">← Back to Graph Creator</button>
        </div>
        <div class="implicit-program-content">
          <div id="loadingIndicator" class="loading-spinner-container">
            <h3>Loading Implicit Function Explorer...</h3>
            <div class="loading-spinner"></div>
          </div>
          <iframe id="implicitProgramFrame" class="implicit-program-iframe" src="" 
                  frameborder="0" 
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                  allowfullscreen
                  sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
        </div>
      </div>
    </div>

    <!-- Brython Script -->
    <script type="text/python">
      from browser import document, alert, window
      import math, json

      # Clear existing chart
      def clear_chart():
          try:
              window.chart.destroy()
          except Exception:
              pass

      # Build chart configuration
      def build_chart_config(data_points, dataset_label):
          chart_type = document["chartType"].value
          chart_title = document["chartTitle"].value.strip()
          x_axis_label = document["xAxisLabel"].value.strip()
          y_axis_label = document["yAxisLabel"].value.strip()
          dataset_color = document["datasetColor"].value
          border_color = document["borderColor"].value
          x_axis_type = document["xAxisType"].value
          y_axis_type = document["yAxisType"].value
          x_scale_type = "linear" if x_axis_type == "Numeric" else "category"
          y_scale_type = "linear" if y_axis_type == "Numeric" else "category"
          
          # Define beautiful color palettes for charts
          elegant_palettes = {
              "neon": ["#ff00cc", "#9933ff", "#00ccff", "#33ff33", "#ff3399", "#ffcc00"],
              "pastel": ["#FFB6C1", "#FFD700", "#87CEFA", "#98FB98", "#DDA0DD", "#FFDAB9"],
              "gradient": ["#9333ea", "#7e22ce", "#6d28d9", "#4f46e5", "#4338ca", "#3b82f6"],
              "ocean": ["#0ea5e9", "#0284c7", "#0369a1", "#075985", "#0c4a6e", "#082f49"],
              "sunset": ["#f97316", "#ea580c", "#c2410c", "#9a3412", "#7c2d12", "#ef4444"],
              "forest": ["#22c55e", "#16a34a", "#15803d", "#166534", "#14532d", "#052e16"]
          }
          
          # Select a palette based on the chart type or randomly
          palette_key = "gradient"  # Default palette
          if chart_type == "line" or chart_type == "area":
              palette_key = "ocean"
          elif chart_type == "bar" or chart_type == "horizontalBar":
              palette_key = "sunset"
          elif chart_type == "scatter":
              palette_key = "neon"
              
          selected_palette = elegant_palettes[palette_key]
          
          # For pie charts, use all colors from the palette
          if chart_type == "pie":
              num_segments = len(data_points)
              background_colors = []
              border_colors = []
              
              # Use palette colors and extend if needed
              for i in range(num_segments):
                  color_index = i % len(selected_palette)
                  base_color = selected_palette[color_index]
                  # Extract RGB components with alpha variations
                  r, g, b = int(base_color[1:3], 16), int(base_color[3:5], 16), int(base_color[5:7], 16)
                  bg_color = f"rgba({r}, {g}, {b}, 0.8)"
                  border_color = f"rgba({r}, {g}, {b}, 1.0)"
                  background_colors.append(bg_color)
                  border_colors.append(border_color)
              
              config = {
                  "type": "pie",
                  "data": {
                      "labels": [str(point["x"]) for point in data_points],
                      "datasets": [{
                          "data": [point["y"] for point in data_points],
                          "backgroundColor": background_colors,
                          "borderColor": border_colors,
                          "borderWidth": 2,
                          "hoverOffset": 15,
                          "borderRadius": 5,
                          "hoverBorderWidth": 3,
                          "shadowOffsetX": 3,
                          "shadowOffsetY": 3,
                          "shadowBlur": 10,
                          "shadowColor": "rgba(0, 0, 0, 0.5)"
                      }]
                  },
                  "options": {
                      "responsive": True,
                      "plugins": {
                          "legend": {
                              "display": True,
                              "labels": {
                                  "font": {"size": 14, "family": "'Fira Code', monospace"},
                                  "color": "rgba(255, 255, 255, 0.9)",
                                  "padding": 15
                              }
                          },
                          "title": {
                              "display": bool(chart_title),
                              "text": chart_title,
                              "font": {"size": 18, "weight": "bold"},
                              "color": "rgba(255, 255, 255, 0.9)",
                              "padding": {"top": 10, "bottom": 25}
                          }
                      },
                      "animation": {
                          "animateScale": True,
                          "animateRotate": True,
                          "duration": 2000,
                          "easing": "easeOutQuart"
                      }
                  }
              }
              return config
          else:
              # For other chart types, use enhanced colors from palette
              main_color = selected_palette[0]  # Use the first color from the palette
              
              # Override colors if user has selected them manually
              if dataset_color != "#4caf50" or border_color != "#4caf50":
                  # User has changed the default color, respect their choice
                  main_color = dataset_color
              else:
                  # Use palette color and set the input field to match
                  document["datasetColor"].value = main_color
                  document["borderColor"].value = main_color
              
              # Extract RGB components
              r, g, b = int(main_color[1:3], 16), int(main_color[3:5], 16), int(main_color[5:7], 16)
              
              # Create a slight variation for the border
              border_r = min(255, int(r * 0.9))
              border_g = min(255, int(g * 0.9))
              border_b = min(255, int(b * 0.9))
              
              # Set solid colors for all chart types for reliability
              background_color = f"rgba({r}, {g}, {b}, 0.7)"
              border_color = f"rgb({border_r}, {border_g}, {border_b})"
              hover_background_color = f"rgba({r}, {g}, {b}, 1.0)"
              point_border_color = "rgba(255, 255, 255, 0.9)"
          
          config = {
              "type": chart_type,
              "data": {
                  "datasets": [{
                      "label": dataset_label,
                      "data": data_points,
                          "backgroundColor": background_color,
                          "borderColor": border_color,
                          "borderWidth": 3,
                          "pointRadius": 6 if dataset_label == "Data Points" else 0,
                          "pointHoverRadius": 10 if dataset_label == "Data Points" else 0,
                          "pointBackgroundColor": hover_background_color,
                          "pointBorderColor": point_border_color,
                          "pointBorderWidth": 2,
                      "fill": False,
                          "tension": 0.4,
                          "cubicInterpolationMode": "monotone",
                          "hoverBackgroundColor": hover_background_color,
                          "hoverBorderColor": "rgba(255, 255, 255, 1.0)"
                  }]
              },
              "options": {
                  "scales": {
                          "x": {
                              "type": x_scale_type,
                              "position": "bottom",
                              "title": {"display": bool(x_axis_label), "text": x_axis_label, "color": "rgba(255, 255, 255, 0.9)", "font": {"size": 16, "weight": "bold"}},
                              "grid": {
                                  "display": True,
                                  "color": "rgba(255, 255, 255, 0.1)",
                                  "tickColor": "rgba(255, 255, 255, 0.2)",
                                  "z": -1
                              },
                              "ticks": {
                                  "color": "rgba(255, 255, 255, 0.7)",
                                  "font": {"family": "'Fira Code', monospace"}
                              }
                          },
                          "y": {
                              "type": y_scale_type,
                              "title": {"display": bool(y_axis_label), "text": y_axis_label, "color": "rgba(255, 255, 255, 0.9)", "font": {"size": 16, "weight": "bold"}},
                              "grid": {
                                  "display": True,
                                  "color": "rgba(255, 255, 255, 0.1)",
                                  "tickColor": "rgba(255, 255, 255, 0.2)",
                                  "z": -1
                              },
                              "ticks": {
                                  "color": "rgba(255, 255, 255, 0.7)",
                                  "font": {"family": "'Fira Code', monospace"}
                              }
                          }
                  },
                  "plugins": {
                          "legend": {
                              "display": True,
                              "labels": {
                                  "color": "rgba(255, 255, 255, 0.9)",
                                  "font": {"size": 14, "family": "'Fira Code', monospace"},
                                  "padding": 15,
                                  "boxWidth": 15,
                                  "boxHeight": 15,
                                  "usePointStyle": True
                              }
                          },
                          "title": {
                              "display": bool(chart_title),
                              "text": chart_title,
                              "font": {"size": 18, "weight": "bold"},
                              "color": "rgba(255, 255, 255, 0.9)",
                              "padding": {"top": 10, "bottom": 25}
                          },
                          "tooltip": {
                              "enabled": True,
                              "backgroundColor": "rgba(0, 0, 0, 0.7)",
                              "titleFont": {"size": 14, "family": "'Fira Code', monospace"},
                              "bodyFont": {"size": 14, "family": "'Fira Code', monospace"},
                              "padding": 12,
                              "cornerRadius": 8,
                              "caretSize": 6,
                              "displayColors": True,
                              "borderColor": "rgba(255, 255, 255, 0.2)",
                              "borderWidth": 1
                          },
                          "zoom": {
                              "zoom": {
                                  "enabled": True,
                                  "mode": "xy",
                                  "speed": 0.1,
                                  "sensitivity": 3
                              },
                              "pan": {
                                  "enabled": True,
                                  "mode": "xy"
                              }
                          },
                      "annotation": {"annotations": {}}
                      },
                      "interaction": {
                          "mode": "nearest",
                          "intersect": False,
                          "axis": "xy"
                      },
                      "layout": {
                          "padding": 20
                      },
                      "elements": {
                          "line": {
                              "tension": 0.4,
                              "borderWidth": 3,
                              "borderCapStyle": "round",
                              "borderJoinStyle": "round",
                              "cubicInterpolationMode": "monotone"
                          },
                          "point": {
                              "radius": 6,
                              "borderWidth": 2,
                              "hitRadius": 8,
                              "hoverRadius": 10,
                              "hoverBorderWidth": 2
                          },
                          "arc": {
                              "borderWidth": 2,
                              "borderRadius": 5
                          },
                          "bar": {
                              "borderRadius": 8,
                              "borderSkipped": False
                          }
                  }
              }
          }
          
          # Handle special chart types
          if chart_type == "area":
              config["type"] = "line"
              config["data"]["datasets"][0]["fill"] = True
              # Use a simpler solid color for area fill
              config["data"]["datasets"][0]["backgroundColor"] = f"rgba({r}, {g}, {b}, 0.2)"
          elif chart_type == "horizontalBar":
              config["type"] = "bar"
              config["options"]["indexAxis"] = "y"
          elif chart_type == "pie" or chart_type == "doughnut":
              # For pie and doughnut charts, we don't need scales
              config["options"]["scales"] = {}
              
              # Add labels to data if they exist
              if "labels" in document and hasattr(document["labels"], "value"):
                  config["data"]["labels"] = document["labels"].value
              elif isinstance(data_points, list) and all(isinstance(item, dict) and "x" in item for item in data_points):
                  # Extract labels from data points if they're in {x, y} format
                  config["data"]["labels"] = [point["x"] for point in data_points]
                  config["data"]["datasets"][0]["data"] = [point["y"] for point in data_points]
          elif chart_type == "scatter":
              config["data"]["datasets"][0]["pointRadius"] = 8
              config["data"]["datasets"][0]["pointHoverRadius"] = 12
              config["data"]["datasets"][0]["pointStyle"] = "circle"
              config["data"]["datasets"][0]["showLine"] = False
              
              # Just use a single color for all scatter points for simplicity
              config["data"]["datasets"][0]["pointBackgroundColor"] = background_color
              config["data"]["datasets"][0]["pointBorderColor"] = "rgba(255, 255, 255, 0.8)"
              config["data"]["datasets"][0]["pointBorderWidth"] = 1.5
          elif chart_type == "bar":
              # Use a simpler solid color for bars
              config["data"]["datasets"][0]["backgroundColor"] = background_color
              
              # Enhance bar appearance
              config["data"]["datasets"][0]["borderRadius"] = 8
              config["data"]["datasets"][0]["borderSkipped"] = False
              config["data"]["datasets"][0]["borderWidth"] = 1
              config["data"]["datasets"][0]["borderColor"] = border_color
          else:
              config["type"] = chart_type
          
          if "enableAnimation" in document and document["enableAnimation"].checked:
              config["options"]["animation"] = {
                  "duration": 1500,
                  "easing": "easeOutQuart"
              }
          else:
              config["options"]["animation"] = {"duration": 0}
          
          if y_axis_type == "Alphabetic" and x_axis_type == "Numeric" and chart_type not in ["horizontalBar", "pie", "doughnut"]:
              config["options"]["indexAxis"] = "y"
          
          return config

      # Apply transformation animation
      def apply_transform_animation():
          try:
              canvas = document["myChart"]
              
              # Add chart overlay for enhanced visual effects
              graph_content = document.querySelector(".graph-content")
              if not document.querySelector(".chart-overlay"):
                  overlay = document.createElement("div")
                  overlay.className = "chart-overlay"
                  graph_content.appendChild(overlay)
              
              if "enableTransform" in document and document["enableTransform"].checked:
                  canvas.style.transition = "transform 1.2s cubic-bezier(0.34, 1.56, 0.64, 1)"
                  canvas.style.transform = "scale(1.05) translateY(-10px)"
                  window.setTimeout(lambda: setattr(canvas.style, "transform", "scale(1) translateY(0)"), 1200)
              
              # Add subtle pulse animation to chart
              canvas.style.animation = "none"
              void = canvas.offsetHeight  # Trigger reflow
              canvas.style.animation = "chart-glow 6s ease-in-out infinite alternate"
              
              # Remove highlight effect for now as it's causing visual issues
              # if window.chart and window.chart.config.type in ["line", "scatter"]:
              #     add_point_highlight_effect()
          except Exception:
              pass
      
      # Add highlight effect to random data points - keeping the function but not calling it
      def add_point_highlight_effect():
          try:
              graph_content = document.querySelector(".graph-content")
              
              # Remove any existing highlights
              for old_highlight in document.querySelectorAll(".highlight-point"):
                  old_highlight.remove()
              
              # Only proceed if we have data points
              if not hasattr(window, "dataPoints") or not window.dataPoints:
                  return
                  
              # Get a random data point to highlight
              if len(window.dataPoints) > 2:
                  # Choose 2-3 random points to highlight
                  num_highlights = min(3, len(window.dataPoints) // 3)
                  indices = []
                  for _ in range(num_highlights):
                      idx = window.Math.floor(window.Math.random() * len(window.dataPoints))
                      if idx not in indices:  # Avoid duplicates
                          indices.append(idx)
                  
                  # For each selected point, create a highlight
                  for idx in indices:
                      # Create a highlight element
                      highlight = document.createElement("div")
                      highlight.className = "highlight-point"
                      
                      # Calculate the position based on the chart
                      point = window.dataPoints[idx]
                      x_scale = window.chart.scales.x
                      y_scale = window.chart.scales.y
                      
                      # Calculate pixel positions (approximation)
                      canvas = document["myChart"]
                      x_pixel = x_scale.getPixelForValue(point.x) 
                      y_pixel = y_scale.getPixelForValue(point.y)
                      
                      # Set the position - adjust if needed to match chart coordinates
                      highlight.style.left = f"{x_pixel}px"
                      highlight.style.top = f"{y_pixel}px"
                      
                      # Add to the graph content
                      canvas.parentNode.appendChild(highlight)
                      
                      # Make visible with a slight delay
                      delay = window.Math.random() * 1000  # Random delay up to 1 second
                      window.setTimeout(lambda h=highlight: setattr(h.style, "opacity", "1"), delay)
          except Exception:
              pass

      # Create graph from data input
      def create_graph_data(event):
          x_input = document["xValues"].value
          y_input = document["yValues"].value
          x_axis_type = document["xAxisType"].value
          y_axis_type = document["yAxisType"].value
          chart_type = document["chartType"].value

          if chart_type == "pie":
              try:
                  y_values = [float(y.strip()) for y in y_input.split(',') if y.strip()]
                  if any(y < 0 for y in y_values):
                      alert("Pie charts require positive values only.")
                      return
              except Exception:
                  alert("Invalid Y-axis input. Enter comma-separated positive numbers for pie chart.")
                  return
              x_values = [x.strip() for x in x_input.split(',') if x.strip()]
          else:
              if chart_type == "horizontalBar" and (y_axis_type != "Alphabetic" or x_axis_type != "Numeric"):
                  alert("For Horizontal Bar chart, set Y-axis to Alphabetic and X-axis to Numeric.")
                  return

              if x_axis_type == "Numeric":
                  try:
                      x_values = [float(x.strip()) for x in x_input.split(',') if x.strip()]
                  except Exception:
                      alert("Invalid X-axis input. Enter comma-separated numbers.")
                      return
              else:
                  x_values = [x.strip() for x in x_input.split(',') if x.strip()]

              if y_axis_type == "Numeric":
                  try:
                      y_values = [float(y.strip()) for y in y_input.split(',') if y.strip()]
                  except Exception:
                      alert("Invalid Y-axis input. Enter comma-separated numbers.")
                      return
              else:
                  y_values = [y.strip() for y in y_input.split(',') if y.strip()]

          if len(x_values) != len(y_values):
              alert("X and Y value counts must match.")
              return

          if x_axis_type != "Numeric" and y_axis_type != "Numeric":
              alert("At least one axis must be numeric.")
              return
          
          # Add loading effect
          add_graph_loading_effect()

          data_points = [{"x": x_values[i], "y": y_values[i]} for i in range(len(x_values))]
          clear_chart()
          ctx = document["myChart"].getContext("2d")
          config = build_chart_config(data_points, "Data Points")
          window.chart = window.Chart.new(ctx, config)
          window.dataPoints = data_points
          apply_transform_animation()
          
          # Add the reveal animation class to the chart
          canvas = document["myChart"]
          canvas.classList.add("graph-reveal")
          
          # Remove the class after animation completes
          window.setTimeout(lambda: canvas.classList.remove("graph-reveal"), 1200)

      # Create graph from equation
      def create_graph_equation(event):
          eq = document["equation"].value.strip()
          start_str = document["startX"].value.strip()
          end_str = document["endX"].value.strip()
          if not eq or not start_str or not end_str:
              alert("Fill in equation and domain values.")
              return
          try:
              start_x, end_x = float(start_str), float(end_str)
          except Exception:
              alert("Invalid start or end x value.")
              return
          if start_x >= end_x:
              alert("Start x must be less than end x.")
              return
          
          # Add loading effect
          add_graph_loading_effect()

          try:
              def f(x):
                  return eval(eq, {"__builtins__": None, "math": math, "x": x})
              x_values = [start_x + i * (end_x - start_x) / 100 for i in range(101)]
              data_points = []
              for x in x_values:
                  try:
                      y = f(x)
                      if y is not None:
                          data_points.append({"x": x, "y": y})
                  except Exception:
                      pass
          except Exception as e:
              alert(f"Error evaluating equation: {str(e)}")
              return

          clear_chart()
          ctx = document["myChart"].getContext("2d")
          config = build_chart_config(data_points, f"y = {eq}")
          window.chart = window.Chart.new(ctx, config)
          window.dataPoints = data_points
          apply_transform_animation()
          
          # Add the reveal animation class to the chart
          canvas = document["myChart"]
          canvas.classList.add("graph-reveal")
          
          # Remove the class after animation completes
          window.setTimeout(lambda: canvas.classList.remove("graph-reveal"), 1200)
      
      # Add loading effect before graph creation
      def add_graph_loading_effect():
          graph_content = document.querySelector(".graph-content")
          
          # Create loading overlay if it doesn't exist
          if not document.querySelector(".graph-loading"):
              loading = document.createElement("div")
              loading.className = "graph-loading"
              loading.innerHTML = """
                  <div class="graph-loading-spinner"></div>
                  <div class="graph-loading-text">Rendering Graph...</div>
              """
              graph_content.appendChild(loading)
          else:
              document.querySelector(".graph-loading").style.display = "flex"
          
          # Hide loading effect after a short delay
          window.setTimeout(lambda: remove_graph_loading_effect(), 800)
      
      # Remove loading effect
      def remove_graph_loading_effect():
          loading = document.querySelector(".graph-loading")
          if loading:
              loading.style.opacity = "0"
              window.setTimeout(lambda: setattr(loading.style, "display", "none"), 300)

      # Insert trigonometric function into equation input
      def insert_trig_function(event):
          func = document["trigFunction"].value
          if func:
              document["equation"].value = func
              document["trigFunction"].value = ""  # Reset dropdown

      # Export graph as PNG
      def export_graph(event):
          try:
              canvas = document["myChart"]
              a = document.createElement("a")
              a.href = canvas.toDataURL("image/png")
              a.download = "graph.png"
              document.body.appendChild(a)
              a.click()
              document.body.removeChild(a)
          except Exception as e:
              alert(f"Error exporting graph: {str(e)}")

      # Reset zoom
      def reset_zoom(event):
          try:
              window.chart.resetZoom()
          except Exception:
              alert("Zoom reset not available.")

      # Import data from file
      def import_data(event):
          file_input = document["dataFileInput"]
          if not file_input.files:
              return
          file = file_input.files[0]
          reader = window.FileReader.new()
          def onload(ev):
              content = reader.result
              if file.name.lower().endswith(".csv"):
                  lines = content.strip().split("\n")
                  x_values, y_values = [], []
                  for line in lines:
                      parts = line.split(",")
                      if len(parts) >= 2:
                          x_values.append(parts[0].strip())
                          y_values.append(parts[1].strip())
                  document["xValues"].value = ", ".join(x_values)
                  document["yValues"].value = ", ".join(y_values)
                  create_graph_data(None)
              elif file.name.lower().endswith(".json"):
                  try:
                      data = window.JSON.parse(content)
                      x_values = [str(item["x"]) for item in data]
                      y_values = [str(item["y"]) for item in data]
                      document["xValues"].value = ", ".join(x_values)
                      document["yValues"].value = ", ".join(y_values)
                      create_graph_data(None)
                  except Exception as e:
                      alert(f"Error parsing JSON: {str(e)}")
              else:
                  alert("Unsupported file type.")
          reader.bind("load", onload)
          reader.readAsText(file)

      # Analyze data
      def analyze_data(event):
          try:
              y_vals = [float(pt["y"]) for pt in window.dataPoints]
              n = len(y_vals)
              mean_val = sum(y_vals) / n
              sorted_y = sorted(y_vals)
              median_val = sorted_y[n//2] if n % 2 else (sorted_y[n//2 - 1] + sorted_y[n//2]) / 2
              std_dev = math.sqrt(sum((y - mean_val)**2 for y in y_vals) / n)
              document["analysisResults"].text = f"Mean: {mean_val:.2f}\nMedian: {median_val:.2f}\nStd Dev: {std_dev:.2f}"
          except Exception:
              alert("Data analysis requires numeric Y values.")

      # Add regression line
      def add_regression_line(event):
          try:
              x_vals = [float(pt["x"]) for pt in window.dataPoints]
              y_vals = [float(pt["y"]) for pt in window.dataPoints]
              n = len(x_vals)
              sum_x, sum_y = sum(x_vals), sum(y_vals)
              sum_xy = sum(x * y for x, y in zip(x_vals, y_vals))
              sum_x2 = sum(x * x for x in x_vals)
              slope = (n * sum_xy - sum_x * sum_y) / (n * sum_x2 - sum_x**2)
              intercept = (sum_y - slope * sum_x) / n
              reg_points = [{"x": min(x_vals), "y": slope * min(x_vals) + intercept},
                            {"x": max(x_vals), "y": slope * max(x_vals) + intercept}]
              window.chart.data.datasets.append({
                  "label": "Regression Line",
                  "data": reg_points,
                  "borderColor": "rgba(255, 99, 132, 1)",
                  "borderWidth": 2,
                  "pointRadius": 0,
                  "fill": False
              })
              window.chart.update()
          except Exception:
              alert("Regression requires numeric data.")

      # Add annotation
      def add_annotation(event):
          try:
              x_val = float(document["annotationX"].value.strip())
              label = document["annotationLabel"].value.strip()
              chart = window.chart
              if "annotation" not in chart.options.plugins:
                  chart.options.plugins.annotation = {"annotations": {}}
              key = f"annotation{len(chart.options.plugins.annotation.annotations) + 1}"
              chart.options.plugins.annotation.annotations[key] = {
                  "type": "line",
                  "scaleID": "x",
                  "value": x_val,
                  "borderColor": "red",
                  "borderWidth": 2,
                  "label": {"content": label, "enabled": True, "position": "start"}
              }
              chart.update()
          except Exception:
              alert("Invalid annotation X value.")

      # View data table
      def view_data_table(event):
          try:
              container = document["dataTableContainer"]
              if container.style.display == "none":
                  html = "<table class='table table-dark'><thead><tr><th>#</th><th>X</th><th>Y</th></tr></thead><tbody>"
                  for i, pt in enumerate(window.dataPoints):
                      html += f"<tr><td>{i+1}</td><td>{pt['x']}</td><td>{pt['y']}</td></tr>"
                  html += "</tbody></table>"
                  container.innerHTML = html
                  container.style.display = "block"
              else:
                  container.style.display = "none"
          except Exception:
              alert("No data to display.")

      # Download CSV
      def download_csv(event):
          try:
              csv_str = "x,y\n" + "\n".join(f"{pt['x']},{pt['y']}" for pt in window.dataPoints)
              blob = window.Blob.new([csv_str], {"type": "text/csv"})
              a = document.createElement("a")
              a.href = window.URL.createObjectURL(blob)
              a.download = "data.csv"
              document.body.appendChild(a)
              a.click()
              document.body.removeChild(a)
          except Exception:
              alert("No data to download.")

      # Save chart config
      def save_config(event):
          config = {key: document[key].value for key in ["xValues", "yValues", "chartType", "chartTitle", "xAxisLabel", "yAxisLabel", "datasetColor", "borderColor", "xAxisType", "yAxisType"]}
          window.localStorage.setItem("chartConfig", json.dumps(config))
          alert("Chart configuration saved.")

      # Load chart config
      def load_config(event):
          config_str = window.localStorage.getItem("chartConfig")
          if config_str:
              config = json.loads(config_str)
              for key, value in config.items():
                  document[key].value = value
              alert("Chart configuration loaded.")
          else:
              alert("No saved configuration.")

      # Update equation with sliders
      def update_equation_with_params(event):
          a, b, c = document["paramA"].value, document["paramB"].value, document["paramC"].value
          document["equation"].value = f"{a}*x**2 + {b}*x + {c}"
          create_graph_equation(event)

      # Update slider displays
      def update_slider_display(event):
          target = event.target
          document[f"{target.id}Value"].text = target.value

      # Toggle equation type inputs
      def toggle_additional_inputs(event):
          eq_type = document["equationType"].value
          document["parametricInputs"].style.display = "block" if eq_type == "parametric" else "none"
          
          # If implicit is selected, show the external program instead of the normal inputs
          if eq_type == "implicit":
              document["implicitInput"].style.display = "none"
              show_implicit_program()
          else:
              document["implicitInput"].style.display = "block" if eq_type == "implicit" else "none"
      
      # Show the implicit function program with animation
      def show_implicit_program():
          # Get the iframe and loading elements
          implicit_frame = document["implicitProgramFrame"]
          loading_indicator = document["loadingIndicator"]
          
          # Show the loading indicator
          loading_indicator.classList.remove("loading-hidden")
          
          # Set up the overlay first
          overlay = document["implicitProgramOverlay"]
          overlay.classList.remove("fade-out")
          overlay.style.display = "block"
          
          # Define the iframe load handler
          def on_frame_load(evt):
              # Hide loading indicator when frame is loaded
              loading_indicator.classList.add("loading-hidden")
          
          def on_frame_error(evt):
              alert("Failed to load the implicit function program. Please check the URL.")
              hide_implicit_program()
          
          # Bind the load and error events
          implicit_frame.bind("load", on_frame_load)
          implicit_frame.bind("error", on_frame_error)
          
          # Use setTimeout to ensure display is applied before animation
          def show_animation():
              overlay.classList.add("fade-in")
              # Apply body styles to prevent scrolling while overlay is shown
              document.body.style.overflow = "hidden"
              
              # Set the iframe source after the overlay is visible
              # Use a direct URL to the external content
              implicit_frame.src = "https://absaraltaf123.github.io/absar-/filetype.html"
          
          window.setTimeout(show_animation, 10)
      
      # Hide the implicit function program with animation
      def hide_implicit_program(event=None):
          overlay = document["implicitProgramOverlay"]
          implicit_frame = document["implicitProgramFrame"]
          
          # Clear the iframe source to stop any running processes
          implicit_frame.src = ""
          
          overlay.classList.remove("fade-in")
          overlay.classList.add("fade-out")
          
          # Restore body scrolling
          document.body.style.overflow = ""
          
          # After animation completes, hide the overlay
          def hide_overlay():
              overlay.style.display = "none"
              document["loadingIndicator"].classList.remove("loading-hidden")
          
          window.setTimeout(hide_overlay, 500)  # Match the animation duration (0.5s)
          
          # Reset equation type to explicit
          document["equationType"].value = "explicit"
          document["parametricInputs"].style.display = "none"
          document["implicitInput"].style.display = "none"

      # Plot additional equations
      def plot_additional_equation(event):
          eq_type = document["equationType"].value
          if eq_type == "explicit":
              create_graph_equation(event)
          elif eq_type == "parametric":
              x_eq, y_eq = document["parametricX"].value.strip(), document["parametricY"].value.strip()
              start_t, end_t = document["startT"].value.strip() or "0", document["endT"].value.strip() or "6.28"
              try:
                  start_t, end_t = float(start_t), float(end_t)
                  if start_t >= end_t:
                      raise ValueError
                  t_values = [start_t + i * (end_t - start_t) / 100 for i in range(101)]
                  data_points = []
                  for t in t_values:
                      x = eval(x_eq, {"__builtins__": None, "math": math, "t": t})
                      y = eval(y_eq, {"__builtins__": None, "math": math, "t": t})
                      data_points.append({"x": x, "y": y})
                  clear_chart()
                  ctx = document["myChart"].getContext("2d")
                  config = build_chart_config(data_points, "Parametric Equation")
                  window.chart = window.Chart.new(ctx, config)
                  window.dataPoints = data_points
                  apply_transform_animation()
              except Exception:
                  alert("Invalid parametric input.")
          elif eq_type == "implicit":
              eq = document["implicitEquation"].value.strip()
              start_x, end_x = document["startXImplicit"].value.strip() or "-10", document["endXImplicit"].value.strip() or "10"
              start_y, end_y = document["startY"].value.strip() or "-10", document["endY"].value.strip() or "10"
              try:
                  start_x, end_x, start_y, end_y = map(float, [start_x, end_x, start_y, end_y])
                  x_vals = [start_x + i * (end_x - start_x) / 50 for i in range(51)]
                  y_vals = [start_y + i * (end_y - start_y) / 50 for i in range(51)]
                  data_points = []
                  for x in x_vals:
                      for y in y_vals:
                          if abs(eval(eq, {"__builtins__": None, "math": math, "x": x, "y": y})) < 0.1:
                              data_points.append({"x": x, "y": y})
                  clear_chart()
                  ctx = document["myChart"].getContext("2d")
                  config = build_chart_config(data_points, "Implicit Equation")
                  window.chart = window.Chart.new(ctx, config)
                  window.dataPoints = data_points
                  apply_transform_animation()
              except Exception:
                  alert("Invalid implicit input.")

      # Handle tab switching
      def on_tab_change(ev):
          target_id = ev.target.getAttribute("data-target")
          for panel in ["#dataPanel", "#equationPanel"]:
              document.querySelector(panel).classList.toggle("active", panel == target_id)
          for btn in document.querySelectorAll(".custom-nav button"):
              btn.classList.toggle("active", btn.getAttribute("data-target") == target_id)
          document["moreOptionsContainer"].style.display = "block" if target_id == "#dataPanel" else "none"
          clear_chart()

      # Toggle distribution parameter inputs based on selected distribution type
      def toggle_distribution_params(event):
          dist_type = document["distributionType"].value
          # Hide all parameter divs first
          for params_div in document.querySelectorAll(".distribution-params"):
              params_div.style.display = "none"
          
          # Show the selected distribution's parameters
          if dist_type == "normal":
              document["normalParams"].style.display = "block"
          elif dist_type == "uniform":
              document["uniformParams"].style.display = "block"
          elif dist_type == "exponential":
              document["exponentialParams"].style.display = "block"
          elif dist_type == "poisson":
              document["poissonParams"].style.display = "block"
          elif dist_type == "binomial":
              document["binomialParams"].style.display = "block"

      # Calculate numerical derivative of a function
      def calculate_derivative(func, x, h=0.0001):
          # Central difference formula for better accuracy
          return (func(x + h) - func(x - h)) / (2 * h)
      
      # Show derivative of the current equation
      def show_derivative(event):
          eq = document["equation"].value.strip()
          start_str = document["startX"].value.strip()
          end_str = document["endX"].value.strip()
          derivative_color = document["derivativeColor"].value
          derivative_width = float(document["derivativeWidth"].value)
          
          if not eq or not start_str or not end_str:
              alert("Fill in equation and domain values first.")
              return
          
          try:
              start_x, end_x = float(start_str), float(end_str)
          except Exception:
              alert("Invalid start or end x value.")
              return
          
          if start_x >= end_x:
              alert("Start x must be less than end x.")
              return
          
          # Add loading effect
          add_graph_loading_effect()
          
          try:
              # Function to evaluate the original equation
              def f(x):
                  try:
                      return eval(eq, {"__builtins__": None, "math": math, "x": x})
                  except Exception:
                      return None
              
              # Calculate original function points
              x_values = [start_x + i * (end_x - start_x) / 100 for i in range(101)]
              original_data_points = []
              for x in x_values:
                  try:
                      y = f(x)
                      if y is not None and not math.isinf(y) and not math.isnan(y):
                          original_data_points.append({"x": x, "y": y})
                  except Exception:
                      pass
              
              # Calculate derivative points using numerical differentiation
              derivative_data_points = []
              for x in x_values:
                  try:
                      # Calculate the derivative at this point
                      derivative_y = calculate_derivative(f, x)
                      if derivative_y is not None and not math.isinf(derivative_y) and not math.isnan(derivative_y):
                          derivative_data_points.append({"x": x, "y": derivative_y})
                  except Exception:
                      pass
              
              # Create/update chart with both original function and its derivative
              clear_chart()
              ctx = document["myChart"].getContext("2d")
              
              # Create config for the original function with standard settings
              config = build_chart_config(original_data_points, f"y = {eq}")
              
              # Add a second dataset for the derivative if checkbox is checked
              if document["showDerivative"].checked:
                  derivative_dataset = {
                      "label": f"d/dx({eq})",
                      "data": derivative_data_points,
                      "backgroundColor": derivative_color,
                      "borderColor": derivative_color,
                      "borderWidth": derivative_width,
                      "pointRadius": 0,  # No points for smoother appearance
                      "borderDash": [5, 5],  # Dashed line for the derivative
                      "tension": 0.4,
                      "fill": False
                  }
                  config["data"]["datasets"].append(derivative_dataset)
              
              # Create the chart
              window.chart = window.Chart.new(ctx, config)
              window.dataPoints = original_data_points
              apply_transform_animation()
              
              # Add the reveal animation class to the chart
              canvas = document["myChart"]
              canvas.classList.add("graph-reveal")
              
              # Remove the class after animation completes
              window.setTimeout(lambda: canvas.classList.remove("graph-reveal"), 1200)
              
          except Exception as e:
              alert(f"Error calculating derivative: {str(e)}")
              return
              
      # Helper function for factorial calculation
      def factorial(n):
          if n == 0 or n == 1:
              return 1
          else:
              # Use iterative approach to avoid recursion depth issues
              result = 1
              for i in range(2, n + 1):
                  result *= i
              return result
      
      # Helper function for binomial coefficient
      def binomial_coef(n, k):
          # More efficient calculation to avoid large factorials
          if k < 0 or k > n:
              return 0
          if k > n - k:
              k = n - k
          result = 1
          for i in range(k):
              result = result * (n - i) // (i + 1)
          return result
              
      # Plot probability distribution
      def plot_distribution(event):
          dist_type = document["distributionType"].value
          start_x = -10
          end_x = 10
          
          # Add loading effect
          add_graph_loading_effect()
          
          try:
              # Generate x values for the distribution
              x_values = [start_x + i * (end_x - start_x) / 200 for i in range(201)]
              data_points = []
              
              # Calculate y values based on the probability distribution
              if dist_type == "normal":
                  # Normal distribution
                  mean = float(document["normalMean"].value)
                  std_dev = float(document["normalStdDev"].value)
                  
                  def normal_pdf(x, mean, std_dev):
                      # Normal probability density function
                      return (1 / (std_dev * math.sqrt(2 * math.pi))) * math.exp(-0.5 * ((x - mean) / std_dev) ** 2)
                  
                  # Adjust x range to focus on the significant part of the distribution
                  x_values = [mean - 4*std_dev + i * (8*std_dev) / 200 for i in range(201)]
                  
                  for x in x_values:
                      try:
                          y = normal_pdf(x, mean, std_dev)
                          if not math.isnan(y) and not math.isinf(y):
                              data_points.append({"x": x, "y": y})
                      except Exception:
                          pass
                  
                  title = f"Normal Distribution (μ={mean}, σ={std_dev})"
                  
              elif dist_type == "uniform":
                  # Uniform distribution
                  a = float(document["uniformMin"].value)
                  b = float(document["uniformMax"].value)
                  
                  if a >= b:
                      alert("Minimum value must be less than maximum value.")
                      return
                  
                  def uniform_pdf(x, a, b):
                      # Uniform probability density function
                      if a <= x <= b:
                          return 1 / (b - a)
                      return 0
                  
                  # Adjust x range to focus on the distribution plus some padding
                  x_values = [a - (b-a)*0.2 + i * ((b-a)*1.4) / 200 for i in range(201)]
                  
                  for x in x_values:
                      try:
                          y = uniform_pdf(x, a, b)
                          data_points.append({"x": x, "y": y})
                      except Exception:
                          pass
                  
                  title = f"Uniform Distribution (a={a}, b={b})"
                  
              elif dist_type == "exponential":
                  # Exponential distribution
                  lambda_rate = float(document["exponentialRate"].value)
                  
                  def exponential_pdf(x, rate):
                      # Exponential probability density function
                      if x >= 0:
                          return rate * math.exp(-rate * x)
                      return 0
                  
                  # Adjust x values for exponential distribution - focus on the relevant range
                  max_x = 5 / lambda_rate  # Cover to where PDF gets very small
                  x_values = [i * max_x / 200 for i in range(201)]
                  
                  for x in x_values:
                      try:
                          y = exponential_pdf(x, lambda_rate)
                          data_points.append({"x": x, "y": y})
                      except Exception:
                          pass
                  
                  title = f"Exponential Distribution (λ={lambda_rate})"
                  
              elif dist_type == "poisson":
                  # Poisson distribution
                  lambda_param = float(document["poissonLambda"].value)
                  
                  def poisson_pmf(k, lambda_param):
                      # Poisson probability mass function
                      if k < 0 or k != int(k):
                          return 0
                      # Use a more stable calculation for Poisson PMF
                      k = int(k)
                      log_pmf = k * math.log(lambda_param) - lambda_param - math.log(factorial(k))
                      return math.exp(log_pmf)
                  
                  # Adjust x values for Poisson distribution (discrete)
                  max_k = min(30, int(lambda_param * 3 + 5))  # Limit to reasonable range
                  x_values = list(range(0, max_k + 1))
                  
                  for k in x_values:
                      try:
                          y = poisson_pmf(k, lambda_param)
                          if not math.isnan(y) and not math.isinf(y):
                              data_points.append({"x": k, "y": y})
                      except Exception:
                          pass
                  
                  title = f"Poisson Distribution (λ={lambda_param})"
                  
              elif dist_type == "binomial":
                  # Binomial distribution
                  n = int(document["binomialN"].value)
                  p = float(document["binomialP"].value)
                  
                  def binomial_pmf(k, n, p):
                      # Binomial probability mass function
                      if k < 0 or k > n or k != int(k):
                          return 0
                      # Calculate binomial coefficient * p^k * (1-p)^(n-k)
                      k = int(k)
                      try:
                          coef = binomial_coef(n, k)
                          return coef * (p ** k) * ((1 - p) ** (n - k))
                      except:
                          # Fallback for large values
                          log_pmf = math.log(binomial_coef(n, k)) + k * math.log(p) + (n - k) * math.log(1 - p)
                          return math.exp(log_pmf)
                  
                  # Adjust x values for binomial distribution (discrete)
                  x_values = list(range(0, n + 1))
                  
                  for k in x_values:
                      try:
                          y = binomial_pmf(k, n, p)
                          if not math.isnan(y) and not math.isinf(y):
                              data_points.append({"x": k, "y": y})
                      except Exception:
                          pass
                  
                  title = f"Binomial Distribution (n={n}, p={p})"
              
              # Create chart with probability distribution
              clear_chart()
              ctx = document["myChart"].getContext("2d")
              
              # Create config for the distribution with appropriate chart type
              chart_type = "line"
              if dist_type in ["poisson", "binomial"]:
                  chart_type = "bar"  # Use bar chart for discrete distributions
              
              # Save current chart type and restore after
              original_chart_type = document["chartType"].value
              document["chartType"].value = chart_type
              
              config = build_chart_config(data_points, title)
              
              # For discrete distributions, add special handling
              if dist_type in ["poisson", "binomial"]:
                  config["data"]["datasets"][0]["barPercentage"] = 0.9
                  config["data"]["datasets"][0]["categoryPercentage"] = 0.8
              
              # Create the chart
              window.chart = window.Chart.new(ctx, config)
              window.dataPoints = data_points
              apply_transform_animation()
              
              # Add the reveal animation class to the chart
              canvas = document["myChart"]
              canvas.classList.add("graph-reveal")
              
              # Remove the class after animation completes
              window.setTimeout(lambda: canvas.classList.remove("graph-reveal"), 1200)
              
              # Restore original chart type
              document["chartType"].value = original_chart_type
              
          except Exception as e:
              alert(f"Error plotting distribution: {str(e)}")
              return

      # Bind events
      document["createBtn"].bind("click", create_graph_data)
      document["createEquationBtn"].bind("click", create_graph_equation)
      document["clearDataBtn"].bind("click", lambda ev: clear_chart())
      document["clearEquationBtn"].bind("click", lambda ev: clear_chart())
      document["trigFunction"].bind("change", insert_trig_function)
      document["exportBtn"].bind("click", export_graph)
      document["resetZoomBtn"].bind("click", reset_zoom)
      document["dataFileInput"].bind("change", import_data)
      document["analyzeDataBtn"].bind("click", analyze_data)
      document["addRegressionBtn"].bind("click", add_regression_line)
      document["addAnnotationBtn"].bind("click", add_annotation)
      document["viewDataTableBtn"].bind("click", view_data_table)
      document["downloadCSVBtn"].bind("click", download_csv)
      document["saveConfigBtn"].bind("click", save_config)
      document["loadConfigBtn"].bind("click", load_config)
      document["updateEquationWithParams"].bind("click", update_equation_with_params)
      document["paramA"].bind("input", update_slider_display)
      document["paramB"].bind("input", update_slider_display)
      document["paramC"].bind("input", update_slider_display)
      document["equationType"].bind("change", toggle_additional_inputs)
      document["plotAdditionalBtn"].bind("click", plot_additional_equation)
      document["data-tab"].bind("click", on_tab_change)
      document["equation-tab"].bind("click", on_tab_change)
      document["implicitBackBtn"].bind("click", hide_implicit_program)
      
      # Add event handlers for derivative width slider
      document["derivativeWidth"].bind("input", update_slider_display)
      
      # Add event handlers for probability distribution sliders
      document["normalMean"].bind("input", update_slider_display)
      document["normalStdDev"].bind("input", update_slider_display)
      document["uniformMin"].bind("input", update_slider_display)
      document["uniformMax"].bind("input", update_slider_display)
      document["exponentialRate"].bind("input", update_slider_display)
      document["poissonLambda"].bind("input", update_slider_display)
      document["binomialN"].bind("input", update_slider_display)
      document["binomialP"].bind("input", update_slider_display)
      
      # Bind new event handlers for our added features
      document["distributionType"].bind("change", toggle_distribution_params)
      document["calculateDerivativeBtn"].bind("click", show_derivative)
      document["plotDistributionBtn"].bind("click", plot_distribution)
      
      # Initialize distribution params display on page load
      toggle_distribution_params({"target": document["distributionType"]})
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
