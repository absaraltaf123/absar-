<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enhanced Graph Creator with Responsive & Data Tools</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Chart.js and plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- Brython -->
    <script src="https://cdn.jsdelivr.net/npm/brython@3.10.5/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.10.5/brython_stdlib.js"></script>
    <style>
      /* CSS provided â€“ do not change the rest */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        background: linear-gradient(160deg, #4c2c8c, #2c1f3a 60%);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue",
          Arial, sans-serif;
        color: #fff;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .container {
        display: flex;
        width: 90%;
        height: 90%;
        max-width: 1200px;
        border-radius: 20px;
        overflow: hidden;
        padding: 5px;
        background: linear-gradient(160deg, #9e86ff, #4c2c8c);
        outline: 0.1px solid rgba(255, 255, 255, 1);
        outline-offset: 1px;
      }
      .content-wrapper {
        display: flex;
        width: 100%;
        height: 100%;
        background: #181818;
        border-radius: 18px;
        overflow: hidden;
      }
      .graph-panel {
        flex: 2.3;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        background: #181818;
      }
      .graph-header {
        padding: 17px;
        font-weight: bold;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.08);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        border-top-left-radius: 17px;
      }
      .graph-content {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
      }
      .input-panel {
        flex: 1;
        background: #1e1e1e;
        padding: 19px;
        overflow-y: auto;
        font-family: "Fira Code", monospace;
        font-size: 14px;
        line-height: 1.5;
        position: relative;
      }
      .input-header {
        margin-bottom: 13px;
        color: #9e86ff;
        font-weight: bold;
      }
      .panel {
        display: none;
        flex-direction: column;
      }
      .panel.active {
        display: flex;
      }
      .form-label {
        margin-bottom: 0.5rem;
        display: block;
        color: #fff;
      }
      .form-control {
        width: 100%;
        padding: 11px;
        border-radius: 4px;
        background-color: #2a2a2a;
        border: 1px solid #444;
        color: #fff;
        outline: none;
        margin-bottom: 1rem;
      }
      .btn {
        border: none;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 8px;
        color: #fff;
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        align-self: center;
        margin-top: 1rem;
      }
      .btn-primary {
        background: linear-gradient(90deg, #4caf50, #81c784);
      }
      .btn-primary:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(76, 175, 80, 0.6);
      }
      .btn-secondary {
        background: linear-gradient(90deg, #ff8a80, #ff5252);
      }
      .btn-secondary:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(255, 82, 82, 0.6);
      }
      canvas {
        max-width: 100%;
        max-height: 100%;
        border-radius: 11px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      /* Accordion styles for higher contrast on dark backgrounds */
      .accordion-button {
        background-color: #343a40;
        color: #fff;
      }
      .accordion-button:not(.collapsed) {
        background-color: #495057;
        color: #fff;
      }
      .accordion-body {
        background-color: #495057;
        color: #fff;
      }
      /* Position the More Options at the bottom of the input panel */
      #moreOptionsContainer {
        margin-top: 20px;
      }
      /* Responsive design for mobile devices */
      @media (max-width: 768px) {
        .content-wrapper {
          flex-direction: column;
        }
        .graph-panel,
        .input-panel {
          flex: 1;
          height: 50%;
        }
      }
    </style>
  </head>
  <body onload="brython()">
    <div class="container">
      <div class="content-wrapper">
        <!-- Graph Display Panel -->
        <div class="graph-panel">
          <div class="graph-header">Graph Display</div>
          <div class="graph-content">
            <canvas id="myChart"></canvas>
          </div>
        </div>
        <!-- Input Panel -->
        <div class="input-panel">
          <div class="input-header">Graph Creator</div>
          <!-- Nav Tabs for Data/Equation -->
          <ul class="nav nav-tabs" id="modeTabs">
            <li class="nav-item">
              <a class="nav-link active" id="data-tab" data-bs-toggle="tab" href="#dataPanel" role="tab" aria-controls="dataPanel" aria-selected="true">Data</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="equation-tab" data-bs-toggle="tab" href="#equationPanel" role="tab" aria-controls="equationPanel" aria-selected="false">Equation</a>
            </li>
          </ul>
          <!-- Data Entry Panel (visible by default) -->
          <div id="dataPanel" class="panel tab-pane active">
            <h2>Enter Data</h2>
            <div class="mb-3">
              <label for="xValues" class="form-label">X-axis values:</label>
              <input type="text" id="xValues" class="form-control" placeholder="e.g. 1, 2, 3, 4 or A, B, C, D" />
            </div>
            <div class="mb-3">
              <label for="yValues" class="form-label">Y-axis values:</label>
              <input type="text" id="yValues" class="form-control" placeholder="e.g. 10, 20, 30, 40 or W, X, Y, Z" />
            </div>
            <button id="createBtn" class="btn btn-primary">Create Graph</button>
            <button id="clearDataBtn" class="btn btn-secondary">Clear Graph</button>
          </div>
          <!-- Equation Entry Panel (hidden by default) -->
          <div id="equationPanel" class="panel tab-pane">
            <h2>Enter Equation</h2>
            <div class="mb-3">
              <label for="equation" class="form-label">Equation (in terms of x):</label>
              <input type="text" id="equation" class="form-control" placeholder="e.g. x**2 + 2*x + 1" />
            </div>
            <div class="mb-3">
              <label for="startX" class="form-label">Start x:</label>
              <input type="text" id="startX" class="form-control" placeholder="e.g. -10" />
            </div>
            <div class="mb-3">
              <label for="endX" class="form-label">End x:</label>
              <input type="text" id="endX" class="form-control" placeholder="e.g. 10" />
            </div>
            <button id="createEquationBtn" class="btn btn-primary">Create Graph</button>
            <button id="clearEquationBtn" class="btn btn-secondary">Clear Graph</button>
            <!-- Additional Equation Features Accordion -->
            <div class="accordion mt-3" id="equationAdditionalAccordion">
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingAdditional">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdditional" aria-expanded="false" aria-controls="collapseAdditional">
                    Additional Equation Features
                  </button>
                </h2>
                <div id="collapseAdditional" class="accordion-collapse collapse" aria-labelledby="headingAdditional" data-bs-parent="#equationAdditionalAccordion">
                  <div class="accordion-body">
                    <!-- Feature 1: Interactive Parameter Sliders -->
                    <h5>Interactive Parameter Sliders</h5>
                    <div class="mb-3">
                      <label for="paramA" class="form-label">Coefficient a:</label>
                      <input type="range" id="paramA" class="form-range" min="-10" max="10" step="0.1" value="1">
                      <span id="paramAValue">1</span>
                    </div>
                    <div class="mb-3">
                      <label for="paramB" class="form-label">Coefficient b:</label>
                      <input type="range" id="paramB" class="form-range" min="-10" max="10" step="0.1" value="0">
                      <span id="paramBValue">0</span>
                    </div>
                    <div class="mb-3">
                      <label for="paramC" class="form-label">Coefficient c:</label>
                      <input type="range" id="paramC" class="form-range" min="-10" max="10" step="0.1" value="0">
                      <span id="paramCValue">0</span>
                    </div>
                    <button id="updateEquationWithParams" class="btn btn-primary">Update Equation</button>
                    <hr/>
                    <!-- Feature 5: Support for Implicit and Parametric Equations -->
                    <h5>Implicit and Parametric Equations</h5>
                    <div class="mb-3">
                      <label class="form-label">Equation Type:</label>
                      <select id="equationType" class="form-control">
                        <option value="explicit" selected>Explicit (y = f(x))</option>
                        <option value="implicit">Implicit (F(x,y)=0)</option>
                        <option value="parametric">Parametric (x(t), y(t))</option>
                      </select>
                    </div>
                    <div id="parametricInputs" style="display: none;">
                      <div class="mb-3">
                        <label for="parametricX" class="form-label">x(t):</label>
                        <input type="text" id="parametricX" class="form-control" placeholder="e.g. cos(t)">
                      </div>
                      <div class="mb-3">
                        <label for="parametricY" class="form-label">y(t):</label>
                        <input type="text" id="parametricY" class="form-control" placeholder="e.g. sin(t)">
                      </div>
                      <div class="mb-3">
                        <label for="startT" class="form-label">Start t:</label>
                        <input type="text" id="startT" class="form-control" placeholder="e.g. 0">
                      </div>
                      <div class="mb-3">
                        <label for="endT" class="form-label">End t:</label>
                        <input type="text" id="endT" class="form-control" placeholder="e.g. 6.28">
                      </div>
                    </div>
                    <div id="implicitInput" style="display: none;">
                      <div class="mb-3">
                        <label for="implicitEquation" class="form-label">Implicit Equation (F(x,y)=0):</label>
                        <input type="text" id="implicitEquation" class="form-control" placeholder="e.g. x**2 + y**2 - 1">
                      </div>
                      <div class="mb-3">
                        <label for="startXImplicit" class="form-label">Start x:</label>
                        <input type="text" id="startXImplicit" class="form-control" placeholder="e.g. -10">
                      </div>
                      <div class="mb-3">
                        <label for="endXImplicit" class="form-label">End x:</label>
                        <input type="text" id="endXImplicit" class="form-control" placeholder="e.g. 10">
                      </div>
                      <div class="mb-3">
                        <label for="startY" class="form-label">Start y:</label>
                        <input type="text" id="startY" class="form-control" placeholder="e.g. -1.5">
                      </div>
                      <div class="mb-3">
                        <label for="endY" class="form-label">End y:</label>
                        <input type="text" id="endY" class="form-control" placeholder="e.g. 1.5">
                      </div>
                    </div>
                    <hr/>
                    <!-- Feature 6: Animation and Transformations -->
                    <h5>Animation and Transformations</h5>
                    <div class="mb-3">
                      <label for="enableAnimation" class="form-label">Enable Animated Transitions:</label>
                      <input type="checkbox" id="enableAnimation" class="form-check-input">
                    </div>
                    <div class="mb-3">
                      <label for="enableTransform" class="form-label">Show Transformations:</label>
                      <input type="checkbox" id="enableTransform" class="form-check-input">
                    </div>
                    <button id="plotAdditionalBtn" class="btn btn-primary">Plot Equation</button>
                  </div>
                </div>
              </div>
            </div>
            <!-- End Additional Equation Features Accordion -->
          </div>
          <!-- End Equation Panel -->
          <!-- More Options Container (for Data mode only) -->
          <div id="moreOptionsContainer">
            <div class="accordion" id="moreOptionsAccordion">
              <!-- Customization Category -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingCustomization">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCustomization" aria-expanded="false" aria-controls="collapseCustomization">
                    Customization
                  </button>
                </h2>
                <div id="collapseCustomization" class="accordion-collapse collapse" aria-labelledby="headingCustomization" data-bs-parent="#moreOptionsAccordion">
                  <div class="accordion-body">
                    <div class="mb-3">
                      <label for="xAxisType" class="form-label">X Axis Data Type:</label>
                      <select id="xAxisType" class="form-control">
                        <option value="Numeric" selected>Numeric</option>
                        <option value="Alphabetic">Alphabetic</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="yAxisType" class="form-label">Y Axis Data Type:</label>
                      <select id="yAxisType" class="form-control">
                        <option value="Numeric" selected>Numeric</option>
                        <option value="Alphabetic">Alphabetic</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="chartType" class="form-label">Chart Type:</label>
                      <select id="chartType" class="form-control">
                        <option value="line" selected>Line</option>
                        <option value="bar">Bar</option>
                        <option value="scatter">Scatter</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="chartTitle" class="form-label">Chart Title:</label>
                      <input type="text" id="chartTitle" class="form-control" placeholder="Enter Chart Title" />
                    </div>
                    <div class="mb-3">
                      <label for="xAxisLabel" class="form-label">X Axis Label:</label>
                      <input type="text" id="xAxisLabel" class="form-control" placeholder="Enter X Axis Label" />
                    </div>
                    <div class="mb-3">
                      <label for="yAxisLabel" class="form-label">Y Axis Label:</label>
                      <input type="text" id="yAxisLabel" class="form-control" placeholder="Enter Y Axis Label" />
                    </div>
                    <div class="mb-3">
                      <label for="datasetColor" class="form-label">Dataset Color:</label>
                      <input type="color" id="datasetColor" class="form-control" value="#4caf50" />
                    </div>
                    <div class="mb-3">
                      <label for="borderColor" class="form-label">Border Color:</label>
                      <input type="color" id="borderColor" class="form-control" value="#4caf50" />
                    </div>
                  </div>
                </div>
              </div>
              <!-- File Operations Category -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingFileOps">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFileOps" aria-expanded="false" aria-controls="collapseFileOps">
                    File Operations
                  </button>
                </h2>
                <div id="collapseFileOps" class="accordion-collapse collapse" aria-labelledby="headingFileOps" data-bs-parent="#moreOptionsAccordion">
                  <div class="accordion-body">
                    <div class="mb-3">
                      <label for="dataFileInput" class="form-label">Import Data File (CSV/JSON):</label>
                      <input type="file" id="dataFileInput" class="form-control" accept=".csv, .json" />
                    </div>
                    <div class="mb-3">
                      <button id="exportBtn" class="btn btn-primary">Export Graph</button>
                      <button id="resetZoomBtn" class="btn btn-secondary">Reset Zoom</button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Analysis Tools Category -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingAnalysis">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAnalysis" aria-expanded="false" aria-controls="collapseAnalysis">
                    Analysis Tools
                  </button>
                </h2>
                <div id="collapseAnalysis" class="accordion-collapse collapse" aria-labelledby="headingAnalysis" data-bs-parent="#moreOptionsAccordion">
                  <div class="accordion-body">
                    <div class="mb-3">
                      <button id="analyzeDataBtn" class="btn btn-primary">Analyze Data</button>
                      <button id="addRegressionBtn" class="btn btn-secondary">Add Regression Line</button>
                    </div>
                    <div id="analysisResults" class="mb-3" style="background: #2a2a2a; padding: 10px; border-radius: 5px;"></div>
                  </div>
                </div>
              </div>
              <!-- Annotations Category -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingAnnotations">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAnnotations" aria-expanded="false" aria-controls="collapseAnnotations">
                    Annotations
                  </button>
                </h2>
                <div id="collapseAnnotations" class="accordion-collapse collapse" aria-labelledby="headingAnnotations" data-bs-parent="#moreOptionsAccordion">
                  <div class="accordion-body">
                    <div class="mb-3">
                      <label for="annotationX" class="form-label">Annotation X:</label>
                      <input type="text" id="annotationX" class="form-control" placeholder="Enter X value for annotation" />
                    </div>
                    <div class="mb-3">
                      <label for="annotationLabel" class="form-label">Annotation Label:</label>
                      <input type="text" id="annotationLabel" class="form-control" placeholder="Enter annotation label" />
                    </div>
                    <div class="mb-3">
                      <button id="addAnnotationBtn" class="btn btn-primary">Add Annotation</button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Data Tools Category -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingDataTools">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDataTools" aria-expanded="false" aria-controls="collapseDataTools">
                    Data Tools
                  </button>
                </h2>
                <div id="collapseDataTools" class="accordion-collapse collapse" aria-labelledby="headingDataTools" data-bs-parent="#moreOptionsAccordion">
                  <div class="accordion-body">
                    <div class="mb-3">
                      <button id="viewDataTableBtn" class="btn btn-primary">View Data Table</button>
                    </div>
                    <div id="dataTableContainer" style="display: none; background: #2a2a2a; padding: 10px; border-radius: 5px; margin-bottom: 1rem;"></div>
                    <div class="mb-3">
                      <button id="downloadCSVBtn" class="btn btn-primary">Download Data as CSV</button>
                    </div>
                    <div class="mb-3">
                      <button id="saveConfigBtn" class="btn btn-primary">Save Chart Config</button>
                      <button id="loadConfigBtn" class="btn btn-secondary">Load Chart Config</button>
                    </div>
                  </div>
                </div>
              </div>
            </div> <!-- End accordion -->
          </div> <!-- End More Options Container -->
        </div> <!-- End input-panel -->
      </div> <!-- End content-wrapper -->
    </div> <!-- End container -->

    <!-- Brython Python Script -->
    <script type="text/python">
      from browser import document, alert, window
      import math, json

      # Utility function: destroy existing chart
      def clear_chart():
          try:
              window.chart.destroy()
          except Exception:
              pass

      # Build chart configuration using customization values
      def build_chart_config(data_points, dataset_label):
          chart_type = document["chartType"].value
          chart_title = document["chartTitle"].value.strip()
          x_axis_label = document["xAxisLabel"].value.strip()
          y_axis_label = document["yAxisLabel"].value.strip()
          dataset_color = document["datasetColor"].value
          border_color = document["borderColor"].value
          x_axis_type = document["xAxisType"].value
          y_axis_type = document["yAxisType"].value

          x_scale_type = "linear" if x_axis_type == "Numeric" else "category"
          y_scale_type = "linear" if y_axis_type == "Numeric" else "category"

          config = {
              "type": chart_type,
              "data": {
                  "datasets": [{
                      "label": dataset_label,
                      "data": data_points,
                      "backgroundColor": dataset_color,
                      "borderColor": border_color,
                      "borderWidth": 2,
                      "pointRadius": 4 if dataset_label == "Data Points" else 0,
                      "fill": False,
                      "tension": 0.3
                  }]
              },
              "options": {
                  "scales": {
                      "x": {
                          "type": x_scale_type,
                          "position": "bottom",
                          "title": {
                              "display": True if x_axis_label else False,
                              "text": x_axis_label
                          }
                      },
                      "y": {
                          "type": y_scale_type,
                          "title": {
                              "display": True if y_axis_label else False,
                              "text": y_axis_label
                          }
                      }
                  },
                  "plugins": {
                      "legend": {"display": True},
                      "title": {
                          "display": True if chart_title else False,
                          "text": chart_title
                      },
                      "zoom": {
                          "zoom": {"enabled": True, "mode": "xy"},
                          "pan": {"enabled": True, "mode": "xy"}
                      },
                      "annotation": {"annotations": {}}
                  }
              }
          }
          # Add animation duration based on checkbox
          if "enableAnimation" in document and document["enableAnimation"].checked:
              config["options"]["animation"] = {"duration": 1000}
          else:
              config["options"]["animation"] = {"duration": 0}
          # If Y axis is alphabetic and X axis is numeric, use a horizontal layout
          if y_axis_type == "Alphabetic" and x_axis_type == "Numeric":
              config["options"]["indexAxis"] = "y"
          return config

      # Apply transformation animation if enabled
      def apply_transform_animation():
          try:
              canvas = document["myChart"]
              if "enableTransform" in document and document["enableTransform"].checked:
                  canvas.style.transition = "transform 1s"
                  canvas.style.transform = "scale(1.1)"
                  window.setTimeout(lambda: setattr(canvas.style, "transform", "scale(1)"), 1000)
          except Exception:
              pass

      # Create graph from manual data input
      def create_graph_data(event):
          x_input = document["xValues"].value
          y_input = document["yValues"].value
          x_axis_type = document["xAxisType"].value
          y_axis_type = document["yAxisType"].value

          if x_axis_type == "Numeric":
              try:
                  x_values = [float(x.strip()) for x in x_input.split(',') if x.strip() != '']
              except Exception:
                  alert("Invalid input for X-axis. Please enter valid comma-separated numbers.")
                  return
          else:
              x_values = [x.strip() for x in x_input.split(',') if x.strip() != '']

          if y_axis_type == "Numeric":
              try:
                  y_values = [float(y.strip()) for y in y_input.split(',') if y.strip() != '']
              except Exception:
                  alert("Invalid input for Y-axis. Please enter valid comma-separated numbers.")
                  return
          else:
              y_values = [y.strip() for y in y_input.split(',') if y.strip() != '']

          if len(x_values) != len(y_values):
              alert("The number of X and Y values must be the same.")
              return

          # Ensure at least one axis is numeric for proper plotting
          if x_axis_type != "Numeric" and y_axis_type != "Numeric":
              alert("At least one axis must be numeric for plotting.")
              return

          data_points = [{"x": x_values[i], "y": y_values[i]} for i in range(len(x_values))]
          clear_chart()
          ctx = document["myChart"].getContext("2d")
          config = build_chart_config(data_points, "Data Points")
          window.chart = window.Chart.new(ctx, config)
          window.dataPoints = data_points
          apply_transform_animation()

      # Create graph from equation input (Explicit)
      def create_graph_equation(event):
          eq = document["equation"].value.strip()
          start_str = document["startX"].value.strip()
          end_str = document["endX"].value.strip()
          if not eq or not start_str or not end_str:
              alert("Please fill in the equation and domain values.")
              return
          try:
              start_x = float(start_str)
              end_x = float(end_str)
          except Exception:
              alert("Invalid start or end x value.")
              return
          if start_x >= end_x:
              alert("Start x must be less than end x.")
              return

          try:
              def f(x):
                  return eval(eq, {"__builtins__": None, "math": math, "x": x})
              x_values = [start_x + i * (end_x - start_x) / 100 for i in range(101)]
              data_points = []
              for x in x_values:
                  try:
                      y = f(x)
                  except Exception:
                      y = None
                  if y is not None:
                      data_points.append({"x": x, "y": y})
          except Exception as e:
              alert("Error in evaluating equation: " + str(e))
              return

          clear_chart()
          ctx = document["myChart"].getContext("2d")
          config = build_chart_config(data_points, "y = " + eq)
          window.chart = window.Chart.new(ctx, config)
          window.dataPoints = data_points
          apply_transform_animation()

      # Export the current graph as an image file
      def export_graph(event):
          try:
              canvas = document["myChart"]
              image_data = canvas.toDataURL("image/png")
              a = document.createElement("a")
              a.href = image_data
              a.download = "graph.png"
              document.body.appendChild(a)
              a.click()
              document.body.removeChild(a)
          except Exception as e:
              alert("Error exporting graph: " + str(e))

      # Reset zoom using Chart.js zoom plugin
      def reset_zoom(event):
          try:
              window.chart.resetZoom()
          except Exception as e:
              alert("Zoom reset not available: " + str(e))

      # Import data from CSV or JSON file and automatically create graph
      def import_data(event):
          file_input = document["dataFileInput"]
          files = file_input.files
          if len(files) == 0:
              return
          file = files[0]
          reader = window.FileReader.new()
          def onload(ev):
              content = reader.result
              filename = file.name.lower()
              if filename.endswith(".csv"):
                  lines = content.strip().split("\n")
                  x_values = []
                  y_values = []
                  for line in lines:
                      parts = line.split(",")
                      if len(parts) >= 2:
                          try:
                              x_values.append(parts[0].strip())
                              y_values.append(parts[1].strip())
                          except:
                              pass
                  document["xValues"].value = ", ".join(x_values)
                  document["yValues"].value = ", ".join(y_values)
                  create_graph_data(None)
              elif filename.endswith(".json"):
                  try:
                      data = window.JSON.parse(content)
                      x_values = []
                      y_values = []
                      for item in data:
                          try:
                              x_values.append(str(item["x"]))
                              y_values.append(str(item["y"]))
                          except:
                              pass
                      document["xValues"].value = ", ".join(x_values)
                      document["yValues"].value = ", ".join(y_values)
                      create_graph_data(None)
                  except Exception as e:
                      alert("Error parsing JSON: " + str(e))
              else:
                  alert("Unsupported file type.")
          reader.bind("load", onload)
          reader.readAsText(file)

      # Analyze data: compute mean, median, and standard deviation (only works for numeric data)
      def analyze_data(event):
          try:
              data_points = window.dataPoints
          except Exception:
              alert("No data available for analysis.")
              return
          if not data_points:
              alert("No data available for analysis.")
              return
          try:
              y_vals = [float(pt["y"]) for pt in data_points]
          except Exception:
              alert("Data analysis is available only for numeric Y values.")
              return
          n = len(y_vals)
          mean_val = sum(y_vals) / n
          sorted_y = sorted(y_vals)
          median_val = sorted_y[n//2] if n % 2 == 1 else (sorted_y[n//2 - 1] + sorted_y[n//2]) / 2
          variance = sum((y - mean_val)**2 for y in y_vals) / n
          std_dev = math.sqrt(variance)
          result_text = f"Data Analysis:\nMean: {mean_val:.2f}\nMedian: {median_val:.2f}\nStd Dev: {std_dev:.2f}"
          document["analysisResults"].text = result_text

      # Add a regression line to the current graph
      def add_regression_line(event):
          try:
              data_points = window.dataPoints
          except Exception:
              alert("No data available for regression analysis.")
              return
          if not data_points:
              alert("No data available for regression analysis.")
              return
          try:
              x_vals = [float(pt["x"]) for pt in data_points]
              y_vals = [float(pt["y"]) for pt in data_points]
          except Exception:
              alert("Regression analysis is available only for numeric data.")
              return
          n = len(x_vals)
          sum_x = sum(x_vals)
          sum_y = sum(y_vals)
          sum_xy = sum(x*y for x, y in zip(x_vals, y_vals))
          sum_x2 = sum(x*x for x in x_vals)
          denominator = n*sum_x2 - sum_x**2
          if denominator == 0:
              alert("Cannot compute regression line.")
              return
          slope = (n*sum_xy - sum_x*sum_y) / denominator
          intercept = (sum_y - slope*sum_x) / n
          min_x = min(x_vals)
          max_x = max(x_vals)
          reg_points = [{"x": min_x, "y": slope*min_x + intercept},
                        {"x": max_x, "y": slope*max_x + intercept}]
          chart = window.chart
          chart.data.datasets.append({
              "label": "Regression Line",
              "data": reg_points,
              "backgroundColor": "rgba(255, 99, 132, 0.5)",
              "borderColor": "rgba(255, 99, 132, 1)",
              "borderWidth": 2,
              "pointRadius": 0,
              "fill": False,
              "tension": 0
          })
          chart.update()

      # Add an annotation using Chart.js annotation plugin
      def add_annotation(event):
          annotation_x_str = document["annotationX"].value.strip()
          annotation_label = document["annotationLabel"].value.strip()
          try:
              annotation_x = float(annotation_x_str)
          except Exception:
              alert("Invalid annotation x value.")
              return
          chart = window.chart
          if "annotation" not in chart.options.plugins:
              chart.options.plugins.annotation = {"annotations": {}}
          annotations = chart.options.plugins.annotation.annotations
          if not hasattr(window, "annotationCounter"):
              window.annotationCounter = 1
          else:
              window.annotationCounter += 1
          key = "annotation" + str(window.annotationCounter)
          annotations[key] = {
              "type": "line",
              "scaleID": "x",
              "value": annotation_x,
              "borderColor": "red",
              "borderWidth": 2,
              "label": {
                  "content": annotation_label,
                  "enabled": True,
                  "position": "start"
              }
          }
          chart.update()

      # --- New Creative Functions ---

      # View Data Table: Toggle display of current data in a table format.
      def view_data_table(event):
          try:
              data_points = window.dataPoints
          except Exception:
              alert("No data available to display.")
              return
          if not data_points:
              alert("No data available to display.")
              return
          container = document["dataTableContainer"]
          if container.style.display == "none":
              html = "<table class='table table-dark table-striped'><thead><tr><th>#</th><th>X</th><th>Y</th></tr></thead><tbody>"
              for i, pt in enumerate(data_points):
                  html += f"<tr><td>{i+1}</td><td>{pt['x']}</td><td>{pt['y']}</td></tr>"
              html += "</tbody></table>"
              container.innerHTML = html
              container.style.display = "block"
          else:
              container.style.display = "none"

      # Download current data as a CSV file.
      def download_csv(event):
          try:
              data_points = window.dataPoints
          except Exception:
              alert("No data available to download.")
              return
          if not data_points:
              alert("No data available to download.")
              return
          csv_str = "x,y\n"
          for pt in data_points:
              csv_str += f"{pt['x']},{pt['y']}\n"
          blob = window.Blob.new([csv_str], { "type": "text/csv" })
          url = window.URL.createObjectURL(blob)
          a = document.createElement("a")
          a.href = url
          a.download = "data.csv"
          document.body.appendChild(a)
          a.click()
          document.body.removeChild(a)
          window.URL.revokeObjectURL(url)

      # Save chart configuration to local storage.
      def save_config(event):
          config = {
              "xValues": document["xValues"].value,
              "yValues": document["yValues"].value,
              "chartType": document["chartType"].value,
              "chartTitle": document["chartTitle"].value,
              "xAxisLabel": document["xAxisLabel"].value,
              "yAxisLabel": document["yAxisLabel"].value,
              "datasetColor": document["datasetColor"].value,
              "borderColor": document["borderColor"].value,
              "xAxisType": document["xAxisType"].value,
              "yAxisType": document["yAxisType"].value
          }
          window.localStorage.setItem("chartConfig", json.dumps(config))
          alert("Chart configuration saved.")

      # Load chart configuration from local storage.
      def load_config(event):
          config_str = window.localStorage.getItem("chartConfig")
          if not config_str:
              alert("No saved configuration found.")
              return
          config = json.loads(config_str)
          document["xValues"].value = config.get("xValues", "")
          document["yValues"].value = config.get("yValues", "")
          document["chartType"].value = config.get("chartType", "line")
          document["chartTitle"].value = config.get("chartTitle", "")
          document["xAxisLabel"].value = config.get("xAxisLabel", "")
          document["yAxisLabel"].value = config.get("yAxisLabel", "")
          document["datasetColor"].value = config.get("datasetColor", "#4caf50")
          document["borderColor"].value = config.get("borderColor", "#4caf50")
          document["xAxisType"].value = config.get("xAxisType", "Numeric")
          document["yAxisType"].value = config.get("yAxisType", "Numeric")
          alert("Chart configuration loaded.")

      # --- Additional Features Functions for Equation Panel ---

      # Update equation based on parameter sliders (Feature 1)
      def update_equation_with_params(event):
          a = document["paramA"].value
          b = document["paramB"].value
          c = document["paramC"].value
          eq_str = f"{a}*x**2 + {b}*x + {c}"
          document["equation"].value = eq_str
          create_graph_equation(event)
          apply_transform_animation()

      # Update slider display values
      def update_slider_display(event):
          target = event.target
          if target.id == "paramA":
              document["paramAValue"].text = target.value
          elif target.id == "paramB":
              document["paramBValue"].text = target.value
          elif target.id == "paramC":
              document["paramCValue"].text = target.value

      # Toggle additional inputs based on equation type (Feature 5)
      def toggle_additional_inputs(event):
          eq_type = document["equationType"].value
          if eq_type == "explicit":
              document["parametricInputs"].style.display = "none"
              document["implicitInput"].style.display = "none"
          elif eq_type == "parametric":
              document["parametricInputs"].style.display = "block"
              document["implicitInput"].style.display = "none"
          elif eq_type == "implicit":
              document["parametricInputs"].style.display = "none"
              document["implicitInput"].style.display = "block"

      # Plot additional equation based on selected type (Features 5 & 6)
      def plot_additional_equation(event):
          eq_type = document["equationType"].value
          if eq_type == "explicit":
              create_graph_equation(event)
          elif eq_type == "parametric":
              x_eq = document["parametricX"].value.strip()
              y_eq = document["parametricY"].value.strip()
              start_t_str = document["startT"].value.strip()
              end_t_str = document["endT"].value.strip()
              if not x_eq or not y_eq:
                  alert("Please fill in the parametric functions.")
                  return
              # Use default t values if not provided
              if start_t_str == "":
                  start_t = 0.0
              else:
                  try:
                      start_t = float(start_t_str)
                  except Exception:
                      alert("Invalid start t value.")
                      return
              if end_t_str == "":
                  end_t = 10.0
              else:
                  try:
                      end_t = float(end_t_str)
                  except Exception:
                      alert("Invalid end t value.")
                      return
              if start_t >= end_t:
                  alert("Start t must be less than end t.")
                  return
              t_values = [start_t + i*(end_t - start_t)/100 for i in range(101)]
              data_points = []
              try:
                  def f_x(t):
                      return eval(x_eq, {"__builtins__": None, "math": math, "t": t})
                  def f_y(t):
                      return eval(y_eq, {"__builtins__": None, "math": math, "t": t})
              except Exception as e:
                  alert("Error in parsing parametric equations: " + str(e))
                  return
              for t in t_values:
                  try:
                      x_val = f_x(t)
                      y_val = f_y(t)
                      data_points.append({"x": x_val, "y": y_val})
                  except Exception:
                      continue
              clear_chart()
              ctx = document["myChart"].getContext("2d")
              config = build_chart_config(data_points, "Parametric Equation")
              window.chart = window.Chart.new(ctx, config)
              window.dataPoints = data_points
              apply_transform_animation()
          elif eq_type == "implicit":
              implicit_eq = document["implicitEquation"].value.strip()
              # Use default ranges if not provided
              start_x_str = document["startXImplicit"].value.strip()
              end_x_str = document["endXImplicit"].value.strip()
              start_y_str = document["startY"].value.strip()
              end_y_str = document["endY"].value.strip()
              if not implicit_eq:
                  alert("Please fill in the implicit equation field.")
                  return
              if start_x_str == "":
                  start_x = -10.0
              else:
                  try:
                      start_x = float(start_x_str)
                  except Exception:
                      alert("Invalid start x value.")
                      return
              if end_x_str == "":
                  end_x = 10.0
              else:
                  try:
                      end_x = float(end_x_str)
                  except Exception:
                      alert("Invalid end x value.")
                      return
              if start_y_str == "":
                  start_y = -10.0
              else:
                  try:
                      start_y = float(start_y_str)
                  except Exception:
                      alert("Invalid start y value.")
                      return
              if end_y_str == "":
                  end_y = 10.0
              else:
                  try:
                      end_y = float(end_y_str)
                  except Exception:
                      alert("Invalid end y value.")
                      return
              data_points = []
              tolerance = 0.1
              num_points = 50
              x_values = [start_x + i*(end_x - start_x)/num_points for i in range(num_points+1)]
              y_values = [start_y + i*(end_y - start_y)/num_points for i in range(num_points+1)]
              for x in x_values:
                  for y in y_values:
                      try:
                          value = eval(implicit_eq, {"__builtins__": None, "math": math, "x": x, "y": y})
                          if abs(value) < tolerance:
                              data_points.append({"x": x, "y": y})
                      except Exception:
                          continue
              if not data_points:
                  alert("No points found for the given implicit equation. Try adjusting the range or tolerance.")
                  return
              clear_chart()
              ctx = document["myChart"].getContext("2d")
              config = build_chart_config(data_points, "Implicit Equation")
              window.chart = window.Chart.new(ctx, config)
              window.dataPoints = data_points
              apply_transform_animation()

      # Handle tab change to show/hide more options and clear chart
      def on_tab_shown(ev):
          more_options = document["moreOptionsContainer"]
          clear_chart()
          if ev.target.id == "data-tab":
              more_options.style.display = "block"
          elif ev.target.id == "equation-tab":
              more_options.style.display = "none"

      # Bind events to UI elements
      document["createBtn"].bind("click", create_graph_data)
      document["createEquationBtn"].bind("click", create_graph_equation)
      document["clearDataBtn"].bind("click", lambda ev: clear_chart())
      document["clearEquationBtn"].bind("click", lambda ev: clear_chart())
      document["exportBtn"].bind("click", export_graph)
      document["resetZoomBtn"].bind("click", reset_zoom)
      document["dataFileInput"].bind("change", import_data)
      document["analyzeDataBtn"].bind("click", analyze_data)
      document["addRegressionBtn"].bind("click", add_regression_line)
      document["addAnnotationBtn"].bind("click", add_annotation)
      document["viewDataTableBtn"].bind("click", view_data_table)
      document["downloadCSVBtn"].bind("click", download_csv)
      document["saveConfigBtn"].bind("click", save_config)
      document["loadConfigBtn"].bind("click", load_config)
      # Bind new additional features
      document["updateEquationWithParams"].bind("click", update_equation_with_params)
      document["paramA"].bind("input", update_slider_display)
      document["paramB"].bind("input", update_slider_display)
      document["paramC"].bind("input", update_slider_display)
      document["equationType"].bind("change", toggle_additional_inputs)
      document["plotAdditionalBtn"].bind("click", plot_additional_equation)
      # Bind tab change events
      document["data-tab"].bind("shown.bs.tab", on_tab_shown)
      document["equation-tab"].bind("shown.bs.tab", on_tab_shown)
    </script>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
