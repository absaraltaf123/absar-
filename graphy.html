<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enhanced Graph Creator with Trig Functions & More Charts</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Chart.js and plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- Brython -->
    <script src="https://cdn.jsdelivr.net/npm/brython@3.10.5/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.10.5/brython_stdlib.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        background: linear-gradient(160deg, #4c2c8c, #2c1f3a 60%);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
        color: #fff;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .container {
        display: flex;
        width: 90%;
        height: 90%;
        max-width: 1200px;
        border-radius: 20px;
        overflow: hidden;
        padding: 5px;
        background: linear-gradient(160deg, #9e86ff, #4c2c8c);
        outline: 0.1px solid rgba(255, 255, 255, 1);
        outline-offset: 1px;
      }
      .content-wrapper {
        display: flex;
        width: 100%;
        height: 100%;
        background: #181818;
        border-radius: 18px;
        overflow: hidden;
      }
      .graph-panel {
        flex: 2.3;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        background: #181818;
      }
      .graph-header {
        padding: 17px;
        font-weight: bold;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.08);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        border-top-left-radius: 17px;
      }
      .graph-content {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
      }
      .input-panel {
        flex: 1;
        background: #1e1e1e;
        padding: 18px;
        overflow-y: auto;
        font-family: "Fira Code", monospace;
        font-size: 14px;
        line-height: 1.5;
      }
      .input-header {
        margin-bottom: 13px;
        color: #9e86ff;
        font-weight: bold;
      }
      .panel {
        display: none;
        flex-direction: column;
      }
      .panel.active {
        display: flex;
      }
      .form-label {
        margin-bottom: 0.5rem;
        display: block;
        color: #fff;
      }
      .form-control {
        width: 100%;
        padding: 10px;
        border-radius: 4px;
        background-color: #2a2a2a;
        border: 1px solid #444;
        color: #fff;
        outline: none;
        margin-bottom: 1rem;
      }
      .btn {
        border: none;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 8px;
        color: #fff;
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        align-self: center;
        margin-top: 1rem;
      }
      .btn-primary {
        background: linear-gradient(90deg, #4caf50, #81c784);
      }
      .btn-primary:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(76, 175, 80, 0.6);
      }
      .btn-secondary {
        background: linear-gradient(90deg, #ff8a80, #ff5252);
      }
      .btn-secondary:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(255, 82, 82, 0.6);
      }
      canvas {
        max-width: 100%;
        max-height: 100%;
        border-radius: 11px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .accordion-button {
        background-color: #343a40;
        color: #fff;
      }
      .accordion-button:not(.collapsed) {
        background-color: #495057;
        color: #fff;
      }
      .accordion-body {
        background-color: #495057;
        color: #fff;
      }
      #moreOptionsContainer {
        margin-top: 20px;
      }
      @media (max-width: 768px) {
        .content-wrapper {
          flex-direction: column;
        }
        .graph-panel, .input-panel {
          flex: 1;
          height: 50%;
        }
      }
      .custom-nav {
        display: flex;
        justify-content: space-around;
        background: #1a1a2e;
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 20px;
      }
      .custom-nav button {
        background: #1a1a2e;
        color: #ffffff;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
        font-family: "Fira Code", monospace;
        transition: background 0.3s, color 0.3s;
      }
      .custom-nav button.active {
        background: #e0e0e0;
        color: #000000;
      }
      .custom-nav button:hover {
        background: #4c2c8c;
      }
    </style>
  </head>
  <body onload="brython()">
    <div class="container">
      <div class="content-wrapper">
        <!-- Graph Display Panel -->
        <div class="graph-panel">
          <div class="graph-header">Graph Display</div>
          <div class="graph-content">
            <canvas id="myChart"></canvas>
          </div>
        </div>
        <!-- Input Panel -->
        <div class="input-panel">
          <div class="input-header">Graph Creator</div>
          <div class="custom-nav" id="modeTabs">
            <button class="active" id="data-tab" data-target="#dataPanel">Data</button>
            <button id="equation-tab" data-target="#equationPanel">Equation</button>
          </div>
          <!-- Data Entry Panel -->
          <div id="dataPanel" class="panel active">
            <h2>Enter Data</h2>
            <div class="mb-3">
              <label for="xValues" class="form-label">X-axis values:</label>
              <input type="text" id="xValues" class="form-control" placeholder="e.g. 1, 2, 3, 4 or A, B, C, D" />
            </div>
            <div class="mb-3">
              <label for="yValues" class="form-label">Y-axis values:</label>
              <input type="text" id="yValues" class="form-control" placeholder="e.g. 10, 20, 30, 40 or W, X, Y, Z" />
            </div>
            <button id="createBtn" class="btn btn-primary">Create Graph</button>
            <button id="clearDataBtn" class="btn btn-secondary">Clear Graph</button>
          </div>
          <!-- Equation Entry Panel -->
          <div id="equationPanel" class="panel">
            <h2>Enter Equation</h2>
            <div class="mb-3">
              <label for="equation" class="form-label">Equation (in terms of x):</label>
              <input type="text" id="equation" class="form-control" placeholder="e.g. x**2 + 2*x + 1" />
            </div>
            <div class="mb-3">
              <label for="trigFunction" class="form-label">Or select a function:</label>
              <select id="trigFunction" class="form-control">
                <option value="">-- Select Function --</option>
                <option value="math.sin(x)">sin(x)</option>
                <option value="math.cos(x)">cos(x)</option>
                <option value="math.tan(x)">tan(x)</option>
                <option value="math.log(x)">log(x)</option>
                <option value="math.exp(x)">exp(x)</option>
                <option value="math.sqrt(x)">sqrt(x)</option>
                <option value="abs(x)">abs(x)</option>
                <option value="math.pow(x, 2)">x^2</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="startX" class="form-label">Start x:</label>
              <input type="text" id="startX" class="form-control" placeholder="e.g. -10" />
            </div>
            <div class="mb-3">
              <label for="endX" class="form-label">End x:</label>
              <input type="text" id="endX" class="form-control" placeholder="e.g. 10" />
            </div>
            <button id="createEquationBtn" class="btn btn-primary">Create Graph</button>
            <button id="clearEquationBtn" class="btn btn-secondary">Clear Graph</button>
            <div class="accordion mt-3" id="equationAdditionalAccordion">
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingAdditional">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdditional" aria-expanded="false" aria-controls="collapseAdditional">
                    Additional Equation Features
                  </button>
                </h2>
                <div id="collapseAdditional" class="accordion-collapse collapse" aria-labelledby="headingAdditional" data-bs-parent="#equationAdditionalAccordion">
                  <div class="accordion-body">
                    <h5>Interactive Parameter Sliders</h5>
                    <div class="mb-3">
                      <label for="paramA" class="form-label">Coefficient a:</label>
                      <input type="range" id="paramA" class="form-range" min="-10" max="10" step="0.1" value="1" />
                      <span id="paramAValue">1</span>
                    </div>
                    <div class="mb-3">
                      <label for="paramB" class="form-label">Coefficient b:</label>
                      <input type="range" id="paramB" class="form-range" min="-10" max="10" step="0.1" value="0" />
                      <span id="paramBValue">0</span>
                    </div>
                    <div class="mb-3">
                      <label for="paramC" class="form-label">Coefficient c:</label>
                      <input type="range" id="paramC" class="form-range" min="-10" max="10" step="0.1" value="0" />
                      <span id="paramCValue">0</span>
                    </div>
                    <button id="updateEquationWithParams" class="btn btn-primary">Update Equation</button>
                    <hr />
                    <h5>Implicit and Parametric Equations</h5>
                    <div class="mb-3">
                      <label class="form-label">Equation Type:</label>
                      <select id="equationType" class="form-control">
                        <option value="explicit" selected>Explicit (y = f(x))</option>
                        <option value="implicit">Implicit (F(x,y)=0)</option>
                        <option value="parametric">Parametric (x(t), y(t))</option>
                      </select>
                    </div>
                    <div id="parametricInputs" style="display: none;">
                      <div class="mb-3">
                        <label for="parametricX" class="form-label">x(t):</label>
                        <input type="text" id="parametricX" class="form-control" placeholder="e.g. cos(t)" />
                      </div>
                      <div class="mb-3">
                        <label for="parametricY" class="form-label">y(t):</label>
                        <input type="text" id="parametricY" class="form-control" placeholder="e.g. sin(t)" />
                      </div>
                      <div class="mb-3">
                        <label for="startT" class="form-label">Start t:</label>
                        <input type="text" id="startT" class="form-control" placeholder="e.g. 0" />
                      </div>
                      <div class="mb-3">
                        <label for="endT" class="form-label">End t:</label>
                        <input type="text" id="endT" class="form-control" placeholder="e.g. 6.28" />
                      </div>
                    </div>
                    <div id="implicitInput" style="display: none;">
                      <div class="mb-3">
                        <label for="implicitEquation" class="form-label">Implicit Equation (F(x,y)=0):</label>
                        <input type="text" id="implicitEquation" class="form-control" placeholder="e.g. x**2 + y**2 - 1" />
                      </div>
                      <div class="mb-3">
                        <label for="startXImplicit" class="form-label">Start x:</label>
                        <input type="text" id="startXImplicit" class="form-control" placeholder="e.g. -10" />
                      </div>
                      <div class="mb-3">
                        <label for="endXImplicit" class="form-label">End x:</label>
                        <input type="text" id="endXImplicit" class="form-control" placeholder="e.g. 10" />
                      </div>
                      <div class="mb-3">
                        <label for="startY" class="form-label">Start y:</label>
                        <input type="text" id="startY" class="form-control" placeholder="e.g. -1.5" />
                      </div>
                      <div class="mb-3">
                        <label for="endY" class="form-label">End y:</label>
                        <input type="text" id="endY" class="form-control" placeholder="e.g. 1.5" />
                      </div>
                    </div>
                    <hr />
                    <h5>Animation and Transformations</h5>
                    <div class="mb-3">
                      <label for="enableAnimation" class="form-label">Enable Animated Transitions:</label>
                      <input type="checkbox" id="enableAnimation" class="form-check-input" />
                    </div>
                    <div class="mb-3">
                      <label for="enableTransform" class="form-label">Show Transformations:</label>
                      <input type="checkbox" id="enableTransform" class="form-check-input" />
                    </div>
                    <button id="plotAdditionalBtn" class="btn btn-primary">Plot Equation</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- More Options Container (Data Mode) -->
          <div id="moreOptionsContainer">
            <div class="accordion" id="moreOptionsAccordion">
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingCustomization">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCustomization" aria-expanded="false" aria-controls="collapseCustomization">
                    Customization
                  </button>
                </h2>
                <div id="collapseCustomization" class="accordion-collapse collapse" aria-labelledby="headingCustomization" data-bs-parent="#moreOptionsAccordion">
                  <div class="accordion-body">
                    <div class="mb-3">
                      <label for="xAxisType" class="form-label">X Axis Data Type:</label>
                      <select id="xAxisType" class="form-control">
                        <option value="Numeric" selected>Numeric</option>
                        <option value="Alphabetic">Alphabetic</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="yAxisType" class="form-label">Y Axis Data Type:</label>
                      <select id="yAxisType" class="form-control">
                        <option value="Numeric" selected>Numeric</option>
                        <option value="Alphabetic">Alphabetic</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="chartType" class="form-label">Chart Type:</label>
                      <select id="chartType" class="form-control">
                        <option value="line" selected>Line</option>
                        <option value="bar">Bar</option>
                        <option value="scatter">Scatter</option>
                        <option value="area">Area</option>
                        <option value="horizontalBar">Horizontal Bar</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="chartTitle" class="form-label">Chart Title:</label>
                      <input type="text" id="chartTitle" class="form-control" placeholder="Enter Chart Title" />
                    </div>
                    <div class="mb-3">
                      <label for="xAxisLabel" class="form-label">X Axis Label:</label>
                      <input type="text" id="xAxisLabel" class="form-control" placeholder="Enter X Axis Label" />
                    </div>
                    <div class="mb-3">
                      <label for="yAxisLabel" class="form-label">Y Axis Label:</label>
                      <input type="text" id="yAxisLabel" class="form-control" placeholder="Enter Y Axis Label" />
                    </div>
                    <div class="mb-3">
                      <label for="datasetColor" class="form-label">Dataset Color:</label>
                      <input type="color" id="datasetColor" class="form-control" value="#4caf50" />
                    </div>
                    <div class="mb-3">
                      <label for="borderColor" class="form-label">Border Color:</label>
                      <input type="color" id="borderColor" class="form-control" value="#4caf50" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingFileOps">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFileOps" aria-expanded="false" aria-controls="collapseFileOps">
                    File Operations
                  </button>
                </h2>
                <div id="collapseFileOps" class="accordion-collapse collapse" aria-labelledby="headingFileOps" data-bs-parent="#moreOptionsAccordion">
                  <div class="accordion-body">
                    <div class="mb-3">
                      <label for="dataFileInput" class="form-label">Import Data File (CSV/JSON):</label>
                      <input type="file" id="dataFileInput" class="form-control" accept=".csv, .json" />
                    </div>
                    <div class="mb-3">
                      <button id="exportBtn" class="btn btn-primary">Export Graph</button>
                      <button id="resetZoomBtn" class="btn btn-secondary">Reset Zoom</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingAnalysis">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAnalysis" aria-expanded="false" aria-controls="collapseAnalysis">
                    Analysis Tools
                  </button>
                </h2>
                <div id="collapseAnalysis" class="accordion-collapse collapse" aria-labelledby="headingAnalysis" data-bs-parent="#moreOptionsAccordion">
                  <div class="accordion-body">
                    <div class="mb-3">
                      <button id="analyzeDataBtn" class="btn btn-primary">Analyze Data</button>
                      <button id="addRegressionBtn" class="btn btn-secondary">Add Regression Line</button>
                    </div>
                    <div id="analysisResults" class="mb-3" style="background: #2a2a2a; padding: 10px; border-radius: 5px;"></div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingAnnotations">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAnnotations" aria-expanded="false" aria-controls="collapseAnnotations">
                    Annotations
                  </button>
                </h2>
                <div id="collapseAnnotations" class="accordion-collapse collapse" aria-labelledby="headingAnnotations" data-bs-parent="#moreOptionsAccordion">
                  <div class="accordion-body">
                    <div class="mb-3">
                      <label for="annotationX" class="form-label">Annotation X:</label>
                      <input type="text" id="annotationX" class="form-control" placeholder="Enter X value for annotation" />
                    </div>
                    <div class="mb-3">
                      <label for="annotationLabel" class="form-label">Annotation Label:</label>
                      <input type="text" id="annotationLabel" class="form-control" placeholder="Enter annotation label" />
                    </div>
                    <div class="mb-3">
                      <button id="addAnnotationBtn" class="btn btn-primary">Add Annotation</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingDataTools">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDataTools" aria-expanded="false" aria-controls="collapseDataTools">
                    Data Tools
                  </button>
                </h2>
                <div id="collapseDataTools" class="accordion-collapse collapse" aria-labelledby="headingDataTools" data-bs-parent="#moreOptionsAccordion">
                  <div class="accordion-body">
                    <div class="mb-3">
                      <button id="viewDataTableBtn" class="btn btn-primary">View Data Table</button>
                    </div>
                    <div id="dataTableContainer" style="display: none; background: #2a2a2a; padding: 10px; border-radius: 5px; margin-bottom: 1rem;"></div>
                    <div class="mb-3">
                      <button id="downloadCSVBtn" class="btn btn-primary">Download Data as CSV</button>
                    </div>
                    <div class="mb-3">
                      <button id="saveConfigBtn" class="btn btn-primary">Save Chart Config</button>
                      <button id="loadConfigBtn" class="btn btn-secondary">Load Chart Config</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Brython Script -->
    <script type="text/python">
      from browser import document, alert, window
      import math, json

      # Clear existing chart
      def clear_chart():
          try:
              window.chart.destroy()
          except Exception:
              pass

      # Build chart configuration
      def build_chart_config(data_points, dataset_label):
          chart_type = document["chartType"].value
          chart_title = document["chartTitle"].value.strip()
          x_axis_label = document["xAxisLabel"].value.strip()
          y_axis_label = document["yAxisLabel"].value.strip()
          dataset_color = document["datasetColor"].value
          border_color = document["borderColor"].value
          x_axis_type = document["xAxisType"].value
          y_axis_type = document["yAxisType"].value

          x_scale_type = "linear" if x_axis_type == "Numeric" else "category"
          y_scale_type = "linear" if y_axis_type == "Numeric" else "category"

          config = {
              "type": chart_type,
              "data": {
                  "datasets": [{
                      "label": dataset_label,
                      "data": data_points,
                      "backgroundColor": dataset_color,
                      "borderColor": border_color,
                      "borderWidth": 2,
                      "pointRadius": 4 if dataset_label == "Data Points" else 0,
                      "fill": False,
                      "tension": 0.3
                  }]
              },
              "options": {
                  "scales": {
                      "x": {"type": x_scale_type, "position": "bottom", "title": {"display": bool(x_axis_label), "text": x_axis_label}},
                      "y": {"type": y_scale_type, "title": {"display": bool(y_axis_label), "text": y_axis_label}}
                  },
                  "plugins": {
                      "legend": {"display": True},
                      "title": {"display": bool(chart_title), "text": chart_title},
                      "zoom": {"zoom": {"enabled": True, "mode": "xy"}, "pan": {"enabled": True, "mode": "xy"}},
                      "annotation": {"annotations": {}}
                  }
              }
          }

          # Handle new chart types
          if chart_type == "area":
              config["type"] = "line"
              config["data"]["datasets"][0]["fill"] = True
          elif chart_type == "horizontalBar":
              config["type"] = "bar"
              config["options"]["indexAxis"] = "y"
          else:
              config["type"] = chart_type

          if "enableAnimation" in document and document["enableAnimation"].checked:
              config["options"]["animation"] = {"duration": 1000}
          else:
              config["options"]["animation"] = {"duration": 0}

          if y_axis_type == "Alphabetic" and x_axis_type == "Numeric" and chart_type not in ["horizontalBar"]:
              config["options"]["indexAxis"] = "y"

          return config

      # Apply transformation animation
      def apply_transform_animation():
          try:
              canvas = document["myChart"]
              if "enableTransform" in document and document["enableTransform"].checked:
                  canvas.style.transition = "transform 1s"
                  canvas.style.transform = "scale(1.1)"
                  window.setTimeout(lambda: setattr(canvas.style, "transform", "scale(1)"), 1000)
          except Exception:
              pass

      # Create graph from data input
      def create_graph_data(event):
          x_input = document["xValues"].value
          y_input = document["yValues"].value
          x_axis_type = document["xAxisType"].value
          y_axis_type = document["yAxisType"].value
          chart_type = document["chartType"].value

          if chart_type == "horizontalBar" and (y_axis_type != "Alphabetic" or x_axis_type != "Numeric"):
              alert("For Horizontal Bar chart, set Y-axis to Alphabetic and X-axis to Numeric.")
              return

          if x_axis_type == "Numeric":
              try:
                  x_values = [float(x.strip()) for x in x_input.split(',') if x.strip()]
              except Exception:
                  alert("Invalid X-axis input. Enter comma-separated numbers.")
                  return
          else:
              x_values = [x.strip() for x in x_input.split(',') if x.strip()]

          if y_axis_type == "Numeric":
              try:
                  y_values = [float(y.strip()) for y in y_input.split(',') if y.strip()]
              except Exception:
                  alert("Invalid Y-axis input. Enter comma-separated numbers.")
                  return
          else:
              y_values = [y.strip() for y in y_input.split(',') if y.strip()]

          if len(x_values) != len(y_values):
              alert("X and Y value counts must match.")
              return

          if x_axis_type != "Numeric" and y_axis_type != "Numeric":
              alert("At least one axis must be numeric.")
              return

          data_points = [{"x": x_values[i], "y": y_values[i]} for i in range(len(x_values))]
          clear_chart()
          ctx = document["myChart"].getContext("2d")
          config = build_chart_config(data_points, "Data Points")
          window.chart = window.Chart.new(ctx, config)
          window.dataPoints = data_points
          apply_transform_animation()

      # Create graph from equation
      def create_graph_equation(event):
          eq = document["equation"].value.strip()
          start_str = document["startX"].value.strip()
          end_str = document["endX"].value.strip()
          if not eq or not start_str or not end_str:
              alert("Fill in equation and domain values.")
              return
          try:
              start_x, end_x = float(start_str), float(end_str)
          except Exception:
              alert("Invalid start or end x value.")
              return
          if start_x >= end_x:
              alert("Start x must be less than end x.")
              return

          try:
              def f(x):
                  return eval(eq, {"__builtins__": None, "math": math, "x": x})
              x_values = [start_x + i * (end_x - start_x) / 100 for i in range(101)]
              data_points = []
              for x in x_values:
                  try:
                      y = f(x)
                      if y is not None:
                          data_points.append({"x": x, "y": y})
                  except Exception:
                      pass
          except Exception as e:
              alert(f"Error evaluating equation: {str(e)}")
              return

          clear_chart()
          ctx = document["myChart"].getContext("2d")
          config = build_chart_config(data_points, f"y = {eq}")
          window.chart = window.Chart.new(ctx, config)
          window.dataPoints = data_points
          apply_transform_animation()

      # Insert trigonometric function into equation input
      def insert_trig_function(event):
          func = document["trigFunction"].value
          if func:
              document["equation"].value = func
              document["trigFunction"].value = ""  # Reset dropdown

      # Export graph as PNG
      def export_graph(event):
          try:
              canvas = document["myChart"]
              a = document.createElement("a")
              a.href = canvas.toDataURL("image/png")
              a.download = "graph.png"
              document.body.appendChild(a)
              a.click()
              document.body.removeChild(a)
          except Exception as e:
              alert(f"Error exporting graph: {str(e)}")

      # Reset zoom
      def reset_zoom(event):
          try:
              window.chart.resetZoom()
          except Exception:
              alert("Zoom reset not available.")

      # Import data from file
      def import_data(event):
          file_input = document["dataFileInput"]
          if not file_input.files:
              return
          file = file_input.files[0]
          reader = window.FileReader.new()
          def onload(ev):
              content = reader.result
              if file.name.lower().endswith(".csv"):
                  lines = content.strip().split("\n")
                  x_values, y_values = [], []
                  for line in lines:
                      parts = line.split(",")
                      if len(parts) >= 2:
                          x_values.append(parts[0].strip())
                          y_values.append(parts[1].strip())
                  document["xValues"].value = ", ".join(x_values)
                  document["yValues"].value = ", ".join(y_values)
                  create_graph_data(None)
              elif file.name.lower().endswith(".json"):
                  try:
                      data = window.JSON.parse(content)
                      x_values = [str(item["x"]) for item in data]
                      y_values = [str(item["y"]) for item in data]
                      document["xValues"].value = ", ".join(x_values)
                      document["yValues"].value = ", ".join(y_values)
                      create_graph_data(None)
                  except Exception as e:
                      alert(f"Error parsing JSON: {str(e)}")
              else:
                  alert("Unsupported file type.")
          reader.bind("load", onload)
          reader.readAsText(file)

      # Analyze data
      def analyze_data(event):
          try:
              y_vals = [float(pt["y"]) for pt in window.dataPoints]
              n = len(y_vals)
              mean_val = sum(y_vals) / n
              sorted_y = sorted(y_vals)
              median_val = sorted_y[n//2] if n % 2 else (sorted_y[n//2 - 1] + sorted_y[n//2]) / 2
              std_dev = math.sqrt(sum((y - mean_val)**2 for y in y_vals) / n)
              document["analysisResults"].text = f"Mean: {mean_val:.2f}\nMedian: {median_val:.2f}\nStd Dev: {std_dev:.2f}"
          except Exception:
              alert("Data analysis requires numeric Y values.")

      # Add regression line
      def add_regression_line(event):
          try:
              x_vals = [float(pt["x"]) for pt in window.dataPoints]
              y_vals = [float(pt["y"]) for pt in window.dataPoints]
              n = len(x_vals)
              sum_x, sum_y = sum(x_vals), sum(y_vals)
              sum_xy = sum(x * y for x, y in zip(x_vals, y_vals))
              sum_x2 = sum(x * x for x in x_vals)
              slope = (n * sum_xy - sum_x * sum_y) / (n * sum_x2 - sum_x**2)
              intercept = (sum_y - slope * sum_x) / n
              reg_points = [{"x": min(x_vals), "y": slope * min(x_vals) + intercept},
                            {"x": max(x_vals), "y": slope * max(x_vals) + intercept}]
              window.chart.data.datasets.append({
                  "label": "Regression Line",
                  "data": reg_points,
                  "borderColor": "rgba(255, 99, 132, 1)",
                  "borderWidth": 2,
                  "pointRadius": 0,
                  "fill": False
              })
              window.chart.update()
          except Exception:
              alert("Regression requires numeric data.")

      # Add annotation
      def add_annotation(event):
          try:
              x_val = float(document["annotationX"].value.strip())
              label = document["annotationLabel"].value.strip()
              chart = window.chart
              if "annotation" not in chart.options.plugins:
                  chart.options.plugins.annotation = {"annotations": {}}
              key = f"annotation{len(chart.options.plugins.annotation.annotations) + 1}"
              chart.options.plugins.annotation.annotations[key] = {
                  "type": "line",
                  "scaleID": "x",
                  "value": x_val,
                  "borderColor": "red",
                  "borderWidth": 2,
                  "label": {"content": label, "enabled": True, "position": "start"}
              }
              chart.update()
          except Exception:
              alert("Invalid annotation X value.")

      # View data table
      def view_data_table(event):
          try:
              container = document["dataTableContainer"]
              if container.style.display == "none":
                  html = "<table class='table table-dark'><thead><tr><th>#</th><th>X</th><th>Y</th></tr></thead><tbody>"
                  for i, pt in enumerate(window.dataPoints):
                      html += f"<tr><td>{i+1}</td><td>{pt['x']}</td><td>{pt['y']}</td></tr>"
                  html += "</tbody></table>"
                  container.innerHTML = html
                  container.style.display = "block"
              else:
                  container.style.display = "none"
          except Exception:
              alert("No data to display.")

      # Download CSV
      def download_csv(event):
          try:
              csv_str = "x,y\n" + "\n".join(f"{pt['x']},{pt['y']}" for pt in window.dataPoints)
              blob = window.Blob.new([csv_str], {"type": "text/csv"})
              a = document.createElement("a")
              a.href = window.URL.createObjectURL(blob)
              a.download = "data.csv"
              document.body.appendChild(a)
              a.click()
              document.body.removeChild(a)
          except Exception:
              alert("No data to download.")

      # Save chart config
      def save_config(event):
          config = {key: document[key].value for key in ["xValues", "yValues", "chartType", "chartTitle", "xAxisLabel", "yAxisLabel", "datasetColor", "borderColor", "xAxisType", "yAxisType"]}
          window.localStorage.setItem("chartConfig", json.dumps(config))
          alert("Chart configuration saved.")

      # Load chart config
      def load_config(event):
          config_str = window.localStorage.getItem("chartConfig")
          if config_str:
              config = json.loads(config_str)
              for key, value in config.items():
                  document[key].value = value
              alert("Chart configuration loaded.")
          else:
              alert("No saved configuration.")

      # Update equation with sliders
      def update_equation_with_params(event):
          a, b, c = document["paramA"].value, document["paramB"].value, document["paramC"].value
          document["equation"].value = f"{a}*x**2 + {b}*x + {c}"
          create_graph_equation(event)

      # Update slider displays
      def update_slider_display(event):
          target = event.target
          document[f"{target.id}Value"].text = target.value

      # Toggle equation type inputs
      def toggle_additional_inputs(event):
          eq_type = document["equationType"].value
          document["parametricInputs"].style.display = "block" if eq_type == "parametric" else "none"
          document["implicitInput"].style.display = "block" if eq_type == "implicit" else "none"

      # Plot additional equations
      def plot_additional_equation(event):
          eq_type = document["equationType"].value
          if eq_type == "explicit":
              create_graph_equation(event)
          elif eq_type == "parametric":
              x_eq, y_eq = document["parametricX"].value.strip(), document["parametricY"].value.strip()
              start_t, end_t = document["startT"].value.strip() or "0", document["endT"].value.strip() or "6.28"
              try:
                  start_t, end_t = float(start_t), float(end_t)
                  if start_t >= end_t:
                      raise ValueError
                  t_values = [start_t + i * (end_t - start_t) / 100 for i in range(101)]
                  data_points = []
                  for t in t_values:
                      x = eval(x_eq, {"__builtins__": None, "math": math, "t": t})
                      y = eval(y_eq, {"__builtins__": None, "math": math, "t": t})
                      data_points.append({"x": x, "y": y})
                  clear_chart()
                  ctx = document["myChart"].getContext("2d")
                  config = build_chart_config(data_points, "Parametric Equation")
                  window.chart = window.Chart.new(ctx, config)
                  window.dataPoints = data_points
                  apply_transform_animation()
              except Exception:
                  alert("Invalid parametric input.")
          elif eq_type == "implicit":
              eq = document["implicitEquation"].value.strip()
              start_x, end_x = document["startXImplicit"].value.strip() or "-10", document["endXImplicit"].value.strip() or "10"
              start_y, end_y = document["startY"].value.strip() or "-10", document["endY"].value.strip() or "10"
              try:
                  start_x, end_x, start_y, end_y = map(float, [start_x, end_x, start_y, end_y])
                  x_vals = [start_x + i * (end_x - start_x) / 50 for i in range(51)]
                  y_vals = [start_y + i * (end_y - start_y) / 50 for i in range(51)]
                  data_points = []
                  for x in x_vals:
                      for y in y_vals:
                          if abs(eval(eq, {"__builtins__": None, "math": math, "x": x, "y": y})) < 0.1:
                              data_points.append({"x": x, "y": y})
                  clear_chart()
                  ctx = document["myChart"].getContext("2d")
                  config = build_chart_config(data_points, "Implicit Equation")
                  window.chart = window.Chart.new(ctx, config)
                  window.dataPoints = data_points
                  apply_transform_animation()
              except Exception:
                  alert("Invalid implicit input.")

      # Handle tab switching
      def on_tab_change(ev):
          target_id = ev.target.getAttribute("data-target")
          for panel in ["#dataPanel", "#equationPanel"]:
              document.querySelector(panel).classList.toggle("active", panel == target_id)
          for btn in document.querySelectorAll(".custom-nav button"):
              btn.classList.toggle("active", btn.getAttribute("data-target") == target_id)
          document["moreOptionsContainer"].style.display = "block" if target_id == "#dataPanel" else "none"
          clear_chart()

      # Bind events
      document["createBtn"].bind("click", create_graph_data)
      document["createEquationBtn"].bind("click", create_graph_equation)
      document["clearDataBtn"].bind("click", lambda ev: clear_chart())
      document["clearEquationBtn"].bind("click", lambda ev: clear_chart())
      document["trigFunction"].bind("change", insert_trig_function)
      document["exportBtn"].bind("click", export_graph)
      document["resetZoomBtn"].bind("click", reset_zoom)
      document["dataFileInput"].bind("change", import_data)
      document["analyzeDataBtn"].bind("click", analyze_data)
      document["addRegressionBtn"].bind("click", add_regression_line)
      document["addAnnotationBtn"].bind("click", add_annotation)
      document["viewDataTableBtn"].bind("click", view_data_table)
      document["downloadCSVBtn"].bind("click", download_csv)
      document["saveConfigBtn"].bind("click", save_config)
      document["loadConfigBtn"].bind("click", load_config)
      document["updateEquationWithParams"].bind("click", update_equation_with_params)
      document["paramA"].bind("input", update_slider_display)
      document["paramB"].bind("input", update_slider_display)
      document["paramC"].bind("input", update_slider_display)
      document["equationType"].bind("change", toggle_additional_inputs)
      document["plotAdditionalBtn"].bind("click", plot_additional_equation)
      document["data-tab"].bind("click", on_tab_change)
      document["equation-tab"].bind("click", on_tab_change)
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
